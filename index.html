<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>釣行記録（PWAフロント / コンパクトUI）</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-50">
  <header class="sticky top-0 z-10 backdrop-blur bg-slate-950/70 border-b border-slate-800">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg font-semibold">釣りログ</h1>
      <nav class="flex gap-2 text-sm">
        <button id="navHome" class="px-3 py-1.5 rounded-xl border border-slate-700 hover:bg-slate-800">ホーム</button>
        <button id="navRecord" class="px-3 py-1.5 rounded-xl border border-slate-700 hover:bg-slate-800">釣行の記録</button>
        <button id="navTrips" class="px-3 py-1.5 rounded-xl border border-slate-700 hover:bg-slate-800">釣行の確認</button>
        <button id="navCatches" class="px-3 py-1.5 rounded-xl border border-slate-700 hover:bg-slate-800">釣果の確認</button>
      </nav>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 pb-28 pt-4">
    <!-- ホーム -->
    <section id="homeView" class="space-y-4">
      <div class="rounded-2xl bg-slate-900 border border-slate-800 p-4">
        <div class="text-xl font-bold">釣りログ ホーム</div>
      </div>
      <div class="grid sm:grid-cols-3 gap-4">
        <div class="rounded-2xl bg-slate-900 border border-slate-800 p-4 flex flex-col gap-3">
          <div class="text-lg font-semibold">釣行の確認</div>
          <button id="homeGoTrips" class="py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-semibold">釣行の確認</button>
        </div>
        <div class="rounded-2xl bg-slate-900 border border-slate-800 p-4 flex flex-col gap-3">
          <div class="text-lg font-semibold">釣果の確認</div>
          <button id="homeGoCatches" class="py-2 rounded-xl bg-sky-600 hover:bg-sky-500 font-semibold">釣果の確認</button>
        </div>
        <div class="rounded-2xl bg-slate-900 border border-slate-800 p-4 flex flex-col gap-3">
          <div class="text-lg font-semibold">釣行の記録</div>
          <button id="homeGoRecord" class="py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 font-semibold">釣行記録</button>
        </div>
      </div>
    </section>

    <!-- 釣行の確認（Trips / GViz） -->
    <section id="tripsView" class="hidden">
      <div class="rounded-2xl bg-slate-900 border border-slate-800 p-4 mb-4">
        <h2 class="text-base font-semibold">釣行の確認</h2>
        <div id="tripStatus" class="text-sm text-slate-300 mt-2"></div>
      </div>

      <!-- 一覧 -->
      <div class="grid grid-cols-1 gap-3" id="tripList"></div>

      <!-- 詳細 -->
      <div id="tripDetail" class="hidden mt-4 rounded-2xl bg-slate-900 border border-slate-800 p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">釣行の詳細</h3>
          <button id="btnCloseTripDetail" class="text-sm px-3 py-1.5 rounded-xl border border-slate-700 hover:bg-slate-800">閉じる</button>
        </div>
        <div id="tripDetailBody" class="space-y-4"></div>
      </div>
    </section>

    <!-- 釣果の確認（GViz） -->
    <section id="catchesView" class="hidden">
      <div class="rounded-2xl bg-slate-900 border border-slate-800 p-4 mb-4">
        <h2 class="text-base font-semibold">釣果の確認</h2>

        <div class="grid sm:grid-cols-4 gap-3 mt-3 hidden">
          <label class="block sm:col-span-2">
            <span class="text-xs text-slate-400">スプレッドシートID</span>
            <input id="sheetId" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-sm" />
          </label>
          <label class="block">
            <span class="text-xs text-slate-400">シート名</span>
            <input id="sheetName" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-sm" />
          </label>
          <label class="block">
            <span class="text-xs text-slate-400">方式</span>
            <select id="loadMode" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-sm" disabled>
              <option value="gviz" selected>GViz JSON（リンク共有）</option>
            </select>
          </label>
        </div>
        <div class="flex gap-2 mt-3 hidden">
          <button id="btnLoadSheet" class="px-3 py-2 rounded-xl bg-sky-600 hover:bg-sky-500 font-semibold">読込</button>
          <button id="btnClearSheet" class="px-3 py-2 rounded-xl border border-slate-700 hover:bg-slate-800">クリア</button>
          <div id="sheetStatus" class="text-sm text-slate-300 ml-auto self-center"></div>
        </div>

      <!-- 列マッピング（従来どおり表示/折りたたみ可能） -->
        <details id="mappingPanel" class="mt-3 hidden">
          <summary class="cursor-pointer text-sm text-slate-300">列マッピング</summary>
          <div class="grid sm:grid-cols-3 gap-3 mt-2">
            <label class="block text-sm">写真URL<select id="mapPhoto" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select></label>
            <label class="block text-sm">日付<select id="mapDate" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select></label>
            <label class="block text-sm">時刻<select id="mapTime" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select></label>
            <label class="block text-sm">魚種<select id="mapSpecies" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select></label>
            <label class="block text-sm">サイズ(cm)<select id="mapSize" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select></label>
            <label class="block text-sm">地点名<select id="mapPlace" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select></label>
            <label class="block text-sm">緯度<select id="mapLat" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select></label>
            <label class="block text-sm">経度<select id="mapLng" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select></label>
            <label class="block text-sm">潮<select id="mapTideName" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select></label>
            <label class="block text-sm">潮位<select id="mapTideLevel" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select></label>
            <label class="block text-sm">潮位傾向<select id="mapTideTrend" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select></label>
            <label class="block text-sm">満潮<select id="mapHighTide" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select></label>
            <label class="block text-sm">干潮<select id="mapLowTide" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select></label>
            <label class="block text-sm">メモ<select id="mapNotes" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2 text-sm"></select></label>
          </div>
          <div class="mt-3 flex gap-2">
            <button id="btnSaveMapping" class="px-3 py-1.5 rounded-xl bg-sky-600 hover:bg-sky-500 text-sm font-semibold">
              マッピングを保存
            </button>
            <button id="btnResetMapping" class="px-3 py-1.5 rounded-xl border border-slate-700 hover:bg-slate-800 text-sm">
              保存をクリア
            </button>
            <span id="mappingStatus" class="text-sm text-slate-300 ml-auto"></span>
          </div>
        </details>
      </div>

        <!-- 一覧 -->
        <div class="grid grid-cols-1 gap-3" id="remoteCatchList"></div>

        <!-- 詳細パネル -->
        <div id="remoteCatchDetail" class="hidden mt-4 rounded-2xl bg-slate-900 border border-slate-800 p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">詳細</h3>
            <button id="btnCloseDetail" class="text-sm px-3 py-1.5 rounded-xl border border-slate-700 hover:bg-slate-800">閉じる</button>
          </div>
          <div id="detailBody" class="space-y-4"></div>
        </div>
      </section>

    <!-- 釣行の記録 -->
    <section id="recordView" class="hidden">
      <div class="rounded-2xl bg-slate-900 border border-slate-800 p-4 flex flex-col gap-2 mb-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-slate-400 text-sm">現在のステータス</div>
            <div id="txtStatus" class="text-xl font-bold">未開始</div>
          </div>
          <div class="text-right text-sm text-slate-400">
            <div>Trip ID: <span id="txtTripId">—</span></div>
            <div id="txtPos" class="hidden">位置: <span id="txtLat"></span>, <span id="txtLng"></span></div>
          </div>
        </div>
        <!-- コンパクト：開始＆件数 -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mt-2">
          <div class="rounded-xl bg-slate-800/40 p-3">
            <div class="text-xs text-slate-400">開始</div>
            <div id="txtStartedAt" class="text-sm break-all">—</div>
          </div>
          <div class="rounded-xl bg-slate-800/40 p-3">
            <div class="text-xs text-slate-400">釣果件数</div>
            <div id="txtCatchCount" class="text-sm">0 件</div>
          </div>
        </div>

        <!-- 開始時の天気 / 開始時の潮（1行表示） -->
        <div id="tripWeatherRow" class="grid grid-cols-1 sm:grid-cols-1 gap-2 mt-2"></div>

        <div id="buttonRow" class="flex gap-2 mt-2"></div>
      </div>

      <section>
        <h2 class="text-base font-semibold mb-2">釣果</h2>
        <div id="catchListEmpty" class="text-slate-400 text-sm">まだ登録がありません。<span id="hintAddWhenActive" class="hidden">「＋釣果」から追加できます。</span></div>
        <ul id="catchList" class="space-y-2"></ul>
      </section>

      <div id="bottomBar" class="hidden fixed bottom-0 left-0 right-0 border-t border-slate-800 bg-slate-950/80 backdrop-blur">
        <div class="max-w-4xl mx-auto px-4 py-3 grid grid-cols-2 gap-2">
          <button id="btnAddCatchBottom" class="py-3 rounded-2xl bg-sky-600 hover:bg-sky-500 font-semibold">＋釣果</button>
          <button id="btnEndBottom" class="py-3 rounded-2xl bg-rose-600 hover:bg-rose-500 font-semibold">釣行終了</button>
        </div>
      </div>

      <!-- 釣果モーダル -->
      <div id="catchModal" class="hidden fixed inset-0 z-20 bg-black/60 grid place-items-center p-4">
        <div class="w-full max-w-md rounded-2xl bg-slate-900 border border-slate-800 p-4" onclick="event.stopPropagation()">
          <div class="flex items-center justify-between mb-2">
            <h3 id="modalTitle" class="font-semibold">釣果を追加</h3>
            <button id="btnCloseModal" class="text-slate-400 hover:text-slate-200">×</button>
          </div>
          <div class="space-y-3">
            <label class="block"><span class="text-sm text-slate-300">時刻</span>
              <input id="inpCatchTime" type="datetime-local" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2" />
            </label>
            <label class="block"><span class="text-sm text-slate-300">魚種</span>
              <input id="inpSpecies" type="text" placeholder="例：アジ" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2" />
            </label>
            <div class="grid grid-cols-2 gap-3">
              <label class="block"><span class="text-sm text-slate-300">サイズ(cm)</span>
                <input id="inpSize" type="number" inputmode="decimal" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2" />
              </label>
              <label class="block"><span class="text-sm text-slate-300">重量(g)</span>
                <input id="inpWeight" type="number" inputmode="decimal" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2" />
              </label>
            </div>
            <label class="block"><span class="text-sm text-slate-300">方法（ルアー/リグ 等）</span>
              <input id="inpMethod" type="text" placeholder="例：メタルジグ 20g" class="mt-1 w-full bg-slate-950 border border-slate-700 rounded-xl px-3 py-2" />
            </label>
            <label class="block"><span class="text-sm text-slate-300">写真</span>
              <input id="inpPhoto" type="file" accept="image/*" class="mt-1 w-full text-sm" />
              <img id="imgPreview" alt="preview" class="hidden mt-2 h-32 w-full object-cover rounded-xl border border-slate-800" />
            </label>
          </div>
          <div class="flex gap-2 mt-4">
            <button id="btnCancelCatch" class="flex-1 py-2 rounded-xl border border-slate-700 hover:bg-slate-800">キャンセル</button>
            <button id="btnSaveCatch" class="flex-1 py-2 rounded-2xl bg-sky-600 hover:bg-sky-500 font-semibold">保存</button>
          </div>
        </div>
      </div>

      <!-- 釣行アップロード確認モーダル -->
      <div id="uploadReviewModal" class="hidden fixed inset-0 z-30 bg-black/60 grid place-items-center p-4">
        <div class="w-full max-w-lg rounded-2xl bg-slate-900 border border-slate-800 p-4" onclick="event.stopPropagation()">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">アップロードの確認</h3>
            <button id="btnCloseUploadReview" class="text-slate-400 hover:text-slate-200">×</button>
          </div>
          <div id="uploadReviewBody" class="text-sm text-slate-200 space-y-2 max-h-[65vh] overflow-auto"></div>
          <div class="flex gap-2 mt-4">
            <button id="btnCancelUpload" class="flex-1 py-2 rounded-xl border border-slate-700 hover:bg-slate-800">釣行を続ける</button>
            <button id="btnConfirmUpload" class="flex-1 py-2 rounded-2xl bg-sky-600 hover:bg-sky-500 font-semibold">アップロード</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== Logger =====
    window.LOG = window.LOG || {
      geo: (...a) => console.debug("[Geo]", ...a),
      wx:  (...a) => console.warn("[Weather]", ...a),
      app: (...a) => console.debug("[FishLog]", ...a),
      tide:(...a) => console.debug("[Tide]", ...a),
    };

    // ===== ナビゲーション =====
    const navHome = document.getElementById('navHome');
    const navRecord = document.getElementById('navRecord');
    const navTrips = document.getElementById('navTrips');            // ★追加
    const navCatches = document.getElementById('navCatches');
    const homeView = document.getElementById('homeView');
    const recordView = document.getElementById('recordView');
    const tripsView = document.getElementById('tripsView');          // ★追加
    const catchesView = document.getElementById('catchesView');
    document.getElementById('homeGoRecord').onclick = () => { showView('record'); };
    document.getElementById('homeGoTrips').onclick = () => { showView('trips'); autoLoadTrips(); };   // ★追加
    document.getElementById('homeGoCatches').onclick = () => { showView('catches'); autoLoadCatches(); };
    navHome.onclick = () => showView('home');
    navRecord.onclick = () => showView('record');
    navTrips.onclick = () => { showView('trips'); autoLoadTrips(); };                                  // ★追加
    navCatches.onclick = () => { showView('catches'); autoLoadCatches(); };
    function showView(name){
      homeView.classList.toggle('hidden', name !== 'home');
      recordView.classList.toggle('hidden', name !== 'record');
      tripsView.classList.toggle('hidden', name !== 'trips');    // ★追加
      catchesView.classList.toggle('hidden', name !== 'catches');
    }
    showView('home');


    // ===== JSTのオフセット付きISO =====
    function toOffsetIsoLocal(d){
      const pad = n => String(n).padStart(2,'0');
      const y = d.getFullYear();
      const m = pad(d.getMonth()+1);
      const da = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      const ss = pad(d.getSeconds());
      const offMin = -d.getTimezoneOffset();
      const sign = offMin >= 0 ? '+' : '-';
      const abs = Math.abs(offMin);
      const oh = pad(Math.floor(abs/60));
      const om = pad(abs%60);
      return `${y}-${m}-${da}T${hh}:${mi}:${ss}${sign}${oh}:${om}`;
    }
    function nowIsoLocal(){ return toOffsetIsoLocal(new Date()); }
    function toLocalInputValue(d){
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    // ===== 天気ユーティリティ =====
    function windDegToCardinal(deg){
      if (typeof deg !== 'number' || isNaN(deg)) return '';
      const d = ((deg % 360) + 360) % 360;
      const dirs = ['北','北北東','北東','東北東','東','東南東','南東','南南東','南','南南西','南西','西南西','西','西北西','北西','北北西'];
      const idx = Math.round(d / 22.5) % 16;
      return dirs[idx];
    }
    function formatWeatherBrief(wx){
      if (!wx) return '';
      const parts = [];
      const desc = wx.weather_description || wx.weather_main || '';
      if (desc) parts.push(desc);
      if (typeof wx.temp === 'number') parts.push(`${Math.round(wx.temp * 10) / 10}℃`);
      const sp = (typeof wx.wind_speed === 'number') ? `${Math.round(wx.wind_speed * 10) / 10}m/s` : '';
      const dir = windDegToCardinal(wx.wind_deg);
      if (sp || dir) parts.push(` ${[sp, dir].filter(Boolean).join(' ')}`);
      return parts.join(' / ');
    }

    // ===== OWM（開始/終了時の天気） =====
    const OWM_API_KEY = "b156c6916abc5e6dcc2ba4564f8d1cf9";
    const OWM_BASE = "https://api.openweathermap.org/data/2.5/weather";
    async function fetchWeather(lat, lng, timeoutMs = 10000){
      if (typeof lat !== 'number' || typeof lng !== 'number') throw new Error("座標が未設定です");
      if (!OWM_API_KEY) throw new Error("OWMのAPIキーが未設定です");
      const url = new URL(OWM_BASE);
      url.search = new URLSearchParams({ lat:String(lat), lon:String(lng), appid:OWM_API_KEY, units:"metric", lang:"ja" }).toString();
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort("timeout"), timeoutMs);
      try {
        const res = await fetch(url.toString(), { signal: ctrl.signal });
        if (!res.ok) {
          let msg = `HTTP ${res.status}`;
          try { const err = await res.json(); if (err?.message) msg += `: ${err.message}`; } catch {}
          throw new Error(msg);
        }
        const j = await res.json();
        return mapWeather(j, lat, lng);
      } finally { clearTimeout(t); }
    }
    function mapWeather(j, lat, lng){
      const w = (j.weather && j.weather[0]) || {};
      const rain1h = j.rain && (j.rain["1h"] ?? j.rain["3h"] ?? null);
      const snow1h = j.snow && (j.snow["1h"] ?? j.snow["3h"] ?? null);
      return {
        timestamp: new Date().toISOString(),
        source: "owm:2.5/weather",
        coord: { lat: lat ?? j.coord?.lat ?? null, lng: lng ?? j.coord?.lon ?? null },
        temp: j.main?.temp ?? null,
        feels_like: j.main?.feels_like ?? null,
        pressure: j.main?.pressure ?? null,
        humidity: j.main?.humidity ?? null,
        wind_speed: j.wind?.speed ?? null,
        wind_deg: j.wind?.deg ?? null,
        wind_gust: j.wind?.gust ?? null,
        clouds: j.clouds?.all ?? null,
        visibility: j.visibility ?? null,
        rain_1h: rain1h ?? null,
        snow_1h: snow1h ?? null,
        weather_id: w.id ?? null,
        weather_main: w.main ?? null,
        weather_description: w.description ?? null,
        raw: j
      };
    }

    // ===== GViz（汎用: 釣果/港コードに使用） =====
    const SHEET_ID   = "1Hl-R0K2MKhsgwJJy7o26HVp-C6Lv6K5iEVPdIkAhCWc"; // 新しいスプレッドシートID
    const SHEET_NAME = "Catches";
    const TRIPS_SHEET_NAME = "Trips";            // ← 追加: Trips を読む
    const HARBOR_SHEET_NAME = "港コード一覧";    // ← ここから港データ

    const sheetIdEl = document.getElementById('sheetId');
    const sheetNameEl = document.getElementById('sheetName');
    const btnLoadSheet = document.getElementById('btnLoadSheet');
    const btnClearSheet = document.getElementById('btnClearSheet');
    const sheetStatus = document.getElementById('sheetStatus');
    const mappingPanel = document.getElementById('mappingPanel');
    const mapPhoto = document.getElementById('mapPhoto');
    const mapDate = document.getElementById('mapDate');
    const mapTime = document.getElementById('mapTime');
    const mapSpecies = document.getElementById('mapSpecies');
    const mapSize = document.getElementById('mapSize');
    const mapPlace = document.getElementById('mapPlace');
    const mapLat = document.getElementById('mapLat');
    const mapLng = document.getElementById('mapLng');
    const mapTideName = document.getElementById('mapTideName');
    const mapTideLevel = document.getElementById('mapTideLevel');
    const mapTideTrend = document.getElementById('mapTideTrend');
    const mapHighTide = document.getElementById('mapHighTide');
    const mapLowTide = document.getElementById('mapLowTide');
    const mapNotes = document.getElementById('mapNotes');
    // ▼▼ マッピング保存UIの参照と永続化ヘルパ ▼▼
    const btnSaveMapping  = document.getElementById('btnSaveMapping');
    const btnResetMapping = document.getElementById('btnResetMapping');
    const mappingStatus   = document.getElementById('mappingStatus');

    const LS_MAP_KEY_PREFIX = 'fishlog_mapping_v1';
    const mappingKey = () => `${LS_MAP_KEY_PREFIX}:${SHEET_ID}:${SHEET_NAME}`;

    function readSavedMapping(){
      try { return JSON.parse(localStorage.getItem(mappingKey())) || null; }
      catch { return null; }
    }
    function writeSavedMapping(){
      const obj = {
        photo: mapPhoto.value, date: mapDate.value, time: mapTime.value,
        species: mapSpecies.value, size: mapSize.value, place: mapPlace.value,
        lat: mapLat.value, lng: mapLng.value,
        tideName: mapTideName.value, tideLevel: mapTideLevel.value, tideTrend: mapTideTrend.value,
        highTide: mapHighTide.value, lowTide: mapLowTide.value, notes: mapNotes.value
      };
      localStorage.setItem(mappingKey(), JSON.stringify(obj));
      if (mappingStatus){ mappingStatus.textContent = '保存しました'; setTimeout(()=> mappingStatus.textContent='', 1500); }
    }
    function applySavedMapping(){
      const s = readSavedMapping();
      if (!s) return false;
      const set = (el, v) => { if (v != null) el.value = String(v); };
      set(mapPhoto, s.photo); set(mapDate, s.date); set(mapTime, s.time);
      set(mapSpecies, s.species); set(mapSize, s.size); set(mapPlace, s.place);
      set(mapLat, s.lat); set(mapLng, s.lng);
      set(mapTideName, s.tideName); set(mapTideLevel, s.tideLevel); set(mapTideTrend, s.tideTrend);
      set(mapHighTide, s.highTide); set(mapLowTide, s.lowTide); set(mapNotes, s.notes);
      return true;
    }
    btnSaveMapping  && (btnSaveMapping.onclick  = () => { writeSavedMapping(); });
    btnResetMapping && (btnResetMapping.onclick = () => {
      localStorage.removeItem(mappingKey());
      if (mappingStatus){ mappingStatus.textContent = '保存をクリアしました'; setTimeout(()=> mappingStatus.textContent='', 1500); }
    });
    const remoteCatchList = document.getElementById('remoteCatchList');
    const detailWrap = document.getElementById('remoteCatchDetail');
    const btnCloseDetail = document.getElementById('btnCloseDetail');

    if (sheetIdEl){ sheetIdEl.value = SHEET_ID; sheetIdEl.disabled = true; }
    if (sheetNameEl){ sheetNameEl.value = SHEET_NAME; sheetNameEl.disabled = true; }

    function gvizPayloadToRows(payload){
      const cols = (payload?.table?.cols || []).map(c => c.label || c.id || '');
      const rows = (payload?.table?.rows || []).map(r => {
        const arr = (r.c || []).map(c => c ? (c.v ?? c.f ?? '') : '');
        while (arr.length < cols.length) arr.push('');
        return arr;
      });
      return [cols, ...rows];
    }
    function loadGVizViaJSONP(id, sheet, timeoutMs=12000){
      return new Promise((resolve, reject)=>{
        const url = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheet)}&_=${Date.now()}`;
        const g = (window.google = window.google || {});
        g.visualization = g.visualization || {};
        g.visualization.Query = g.visualization.Query || {};
        const prev = g.visualization.Query.setResponse;
        let settled=false;
        g.visualization.Query.setResponse = (payload)=>{
          if (settled) return; settled=true; cleanup();
          try { resolve(gvizPayloadToRows(payload)); } catch(e){ reject(e); }
        };
        const script=document.createElement('script');
        script.src=url; script.async=true;
        script.onerror=()=>{ if(settled) return; settled=true; cleanup(); reject(new Error('GVizの読み込みに失敗しました（ネットワーク/権限）')); };
        document.head.appendChild(script);
        const timer=setTimeout(()=>{ if(settled) return; settled=true; cleanup(); reject(new Error('GVizがタイムアウト（12秒）')); }, timeoutMs);
        function cleanup(){ clearTimeout(timer); try{script.remove();}catch{} g.visualization.Query.setResponse = prev; }
      });
    }

    // ===== 釣果（リモート閲覧UI） =====
    let lastRows = null;
    let lastHeaders = [];
    let hasLoadedOnce = false;

    // 追加: Trips の月情報マップ
    let tripsById = {}; // { [tripId]: { moon_visual, moon_age, moon_brightness } }

    function autoLoadCatches(){ if (!hasLoadedOnce) btnLoadSheet.click(); }

    function parseGVizDate(str){
      if (typeof str !== 'string') return null;
      const m = str.match(/^Date\(([^)]+)\)/);
      if (!m) return null;
      const nums = m[1].split(',').map(n=>parseInt(n.trim(),10));
      if (!nums.length) return null;
      const [y, m0=0, d=1, hh=0, mi=0] = nums;
      const mm = Math.max(1, Math.min(12, m0 + 1));
      return { y, m:mm, d, hh, mi };
    }
    function z2(n){ return String(n).padStart(2,'0'); }
    function formatSheetDateTime(dateCell, timeCell){
      const d1 = parseGVizDate(String(dateCell||''));
      const t1 = parseGVizDate(String(timeCell||''));
      if (d1 || t1){
        const y = d1?.y ?? new Date().getFullYear();
        const m = d1?.m ?? (new Date().getMonth()+1);
        const d = d1?.d ?? new Date().getDate();
        const hh = t1?.hh ?? 0;
        const mi = t1?.mi ?? 0;
        return `${y}/${z2(m)}/${z2(d)} ${z2(hh)}:${z2(mi)}`;
      }
      const dateStr = (dateCell||'').toString().trim();
      const timeStr = (timeCell||'').toString().trim();
      if (dateStr || timeStr){
        const d = dateStr ? new Date(dateStr) : new Date();
        const ok = !isNaN(d.getTime());
        const y = ok ? d.getFullYear() : '';
        const m = ok ? z2(d.getMonth()+1) : '';
        const da = ok ? z2(d.getDate()) : '';
        let hh='00', mi='00';
        if (timeStr){
          const mm = timeStr.match(/(\d{1,2}):(\d{1,2})/);
          if (mm){ hh = z2(mm[1]); mi = z2(mm[2]); }
        }
        const ymd = (y && m && da) ? `${y}/${m}/${da}` : (dateStr||'');
        const hm = timeStr ? `${hh}:${mi}` : '';
        return [ymd, hm].filter(Boolean).join(' ');
      }
      return '';
    }

    document.getElementById('btnLoadSheet').onclick = async () => {
      const id = SHEET_ID.trim(), sheet = SHEET_NAME.trim();
      sheetStatus.textContent = '読込中...';
      remoteCatchList.innerHTML=''; detailWrap.classList.add('hidden');
      try{
        if (!id || !sheet) throw new Error('シートID/シート名が空です');

        // 1) Trips を先に読み、tripId → 月情報マップを作る
        tripsById = await loadTripsMoonMap();

        // 2) Catches を読み込む
        const rows = await loadGVizViaJSONP(id, sheet);
        if (!rows || rows.length < 2){ sheetStatus.textContent='データが見つかりません（ヘッダ+1行以上が必要）'; hasLoadedOnce=true; return; }
        lastRows = rows; lastHeaders = rows[0];
        setupMapping(lastHeaders);
        renderRemoteList(mapRowsToItems(rows)); // tripId 経由で月情報を付与して描画
        sheetStatus.textContent = `読み込み完了：${rows.length-1}件`;
        hasLoadedOnce = true;
      }catch(e){
        console.error(e);
        sheetStatus.innerHTML = `読込に失敗しました。<span class="text-slate-400">(${e.message||e})</span><br><span class="text-slate-400">共有設定を「リンクを知っている全員（閲覧者）」にし、シート名を確認してください。</span>`;
        hasLoadedOnce = true;
      }
    };
    btnClearSheet && (btnClearSheet.onclick = ()=>{ remoteCatchList.innerHTML=''; detailWrap.classList.add('hidden'); sheetStatus.textContent=''; lastRows=null; lastHeaders=[]; hasLoadedOnce=false; tripsById={}; });
    btnCloseDetail.onclick = ()=> detailWrap.classList.add('hidden');

    function populateSelect(sel, headers){ sel.innerHTML=''; headers.forEach((h,i)=>{ const o=document.createElement('option'); o.value=String(i); o.textContent=h||`列${i+1}`; sel.appendChild(o); }); }

    function setupMapping(headers){
      const H = headers.map(h => String(h || '').trim());

      // 完全一致で列番号取得
      const idx = (name) => {
        const i = H.findIndex(h => h === name);
        return i >= 0 ? String(i) : null;
      };

      // ドロップダウンの中身は従来通り生成
      const selects=[mapPhoto,mapDate,mapTime,mapSpecies,mapSize,mapPlace,mapLat,mapLng,mapTideName,mapTideLevel,mapTideTrend,mapHighTide,mapLowTide,mapNotes];
      selects.forEach(s=>populateSelect(s, headers));

      // ① まずヒューリスティック（最下位の初期値）
      const g=guessMapping(headers);
      mapPhoto.value=g.photo; mapDate.value=g.date; mapTime.value=g.time;
      mapSpecies.value=g.species; mapSize.value=g.size; mapPlace.value=g.place;
      mapLat.value=g.lat; mapLng.value=g.lng; mapTideName.value=g.tideName; mapTideLevel.value=g.tideLevel;
      mapTideTrend.value=g.tideTrend; mapHighTide.value=g.highTide; mapLowTide.value=g.lowTide; mapNotes.value=g.notes;

      // ② 固定名（ヒューリスティックより優先）
      const iView = idx('photo_view_url');
      const iThumb= idx('photo_thumb_url');
      const iId   = idx('photo_file_id');
      if (iView)      mapPhoto.value = iView;
      else if (iThumb)mapPhoto.value = iThumb;
      else if (iId)   mapPhoto.value = iId;

      const iTs = idx('timestamp');
      if (iTs){ mapDate.value = iTs; mapTime.value = iTs; }

      const iSp = idx('species');         if (iSp) mapSpecies.value = iSp;
      const iSz = idx('size_cm');         if (iSz) mapSize.value    = iSz;
      const iTN = idx('tide_name');       if (iTN) mapTideName.value  = iTN;
      const iTL = idx('tide_level_cm');   if (iTL) mapTideLevel.value = iTL;
      const iTT = idx('tide_trend');      if (iTT) mapTideTrend.value = iTT;
      const iHH = idx('tide_high_times'); if (iHH) mapHighTide.value  = iHH;
      const iLL = idx('tide_low_times');  if (iLL) mapLowTide.value   = iLL;

      // ③ 保存済み（最優先）— 無条件で上書き適用
      applySavedMapping();

      // 折りたたみを表示状態で出す（ユーザーが保存できるように）
      mappingPanel.classList.remove('hidden');
      mappingPanel.open = false; // 折りたたみ閉じ

      // 変更時は即プレビュー更新（保存はボタン）
      selects.forEach(s=> s.onchange = ()=> lastRows && renderRemoteList(mapRowsToItems(lastRows)));

      // 初回プレビュー
      lastRows && renderRemoteList(mapRowsToItems(lastRows));
    }

    function guessMapping(headers){
      const L=headers.map(h=>String(h||'')); const lower=L.map(x=>x.toLowerCase());
      const findExact = name => { const i=L.findIndex(x=>x===name); return i>=0?String(i):null; };
      const findAny = keys => { for(let i=0;i<lower.length;i++){ if(keys.some(k=>lower[i].includes(k))) return String(i);} return null; };
      return {
        photo: findExact('写真URL')   ?? findAny(['photo','画像','img','url','link']) ?? '0',
        date:  findExact('日付')      ?? findAny(['date','日付']) ?? '0',
        time:  findExact('時刻')      ?? findAny(['time','時刻']) ?? '0',
        species: findExact('魚種')    ?? findAny(['species','魚種','fish']) ?? '0',
        size:  findExact('サイズ(cm)')?? findAny(['size','cm','サイズ']) ?? '0',
        place: findExact('地点名')    ?? findAny(['地点','場所','point','place','spot']) ?? '0',
        lat:   findExact('緯度')      ?? findAny(['lat','緯度']) ?? '0',
        lng:   findExact('経度')      ?? findAny(['lng','lon','経度']) ?? '0',
        tideName:  findExact('潮')    ?? findAny(['潮','tide']) ?? '0',
        tideLevel: findExact('潮位')  ?? findAny(['潮位','level']) ?? '0',
        tideTrend: findExact('潮位傾向') ?? findAny(['傾向','trend']) ?? '0',
        highTide:  findExact('満潮')  ?? findAny(['満潮','high']) ?? '0',
        lowTide:   findExact('干潮')  ?? findAny(['干潮','low']) ?? '0',
        notes: findExact('メモ')      ?? findAny(['memo','note','備考','コメント','メモ']) ?? '0',
      };
    }

    // 追加: Trips から月情報を読み込む
    async function loadTripsMoonMap(){
      try{
        const rows = await loadGVizViaJSONP(SHEET_ID, TRIPS_SHEET_NAME);
        if (!rows || rows.length < 2) return {};
        const headers = rows[0].map(h=>String(h||'').trim());
        const idxOf = name => headers.findIndex(h => h === name);

        const iTrip = idxOf('tripId');
        const iMb   = idxOf('moon_brightness');
        const iMa   = idxOf('moon_age');
        const iMv   = idxOf('moon_visual');

        const map = {};
        for (let i=1;i<rows.length;i++){
          const r = rows[i];
          const id = r[iTrip] ?? '';
          if (!id) continue;
          map[String(id)] = {
            moon_brightness: r[iMb] ?? '',
            moon_age: r[iMa] ?? '',
            moon_visual: r[iMv] ?? ''
          };
        }
        return map;
      }catch(e){
        console.warn('[Trips] 読み込みに失敗:', e?.message||e);
        return {};
      }
    }

    function mapRowsToItems(rows){
      // 固定列名 tripId を自動検出して紐付け（UIに追加しない）
      const headers = rows[0].map(h=>String(h||'').trim());
      const tripIdx = headers.findIndex(h => h === 'tripId');

      const get=(r,sel)=>{ const idx=Number(sel.value); return Number.isFinite(idx)&&r[idx]!==undefined ? r[idx] : ''; };
      const out=[];
      for(let i=1;i<rows.length;i++){
        const r=rows[i];
        const tripId = (tripIdx>=0) ? (r[tripIdx] ?? '') : '';
        const tripMoon = tripsById && tripId ? (tripsById[String(tripId)] || null) : null;

        out.push({
          tripId,
          // 既存マッピング
          photo:get(r,mapPhoto), date:get(r,mapDate), time:get(r,mapTime), species:get(r,mapSpecies), size:get(r,mapSize),
          place:get(r,mapPlace), lat:get(r,mapLat), lng:get(r,mapLng), tideName:get(r,mapTideName), tideLevel:get(r,mapTideLevel),
          tideTrend:get(r,mapTideTrend), tide_high_times:get(r,mapHighTide), tide_low_times:get(r,mapLowTide), notes:get(r,mapNotes),
          weight:'', method:'',
          // 追加: 月情報（Trips 由来）
          moon_visual: tripMoon?.moon_visual || '',
          moon_age: tripMoon?.moon_age || '',
          moon_brightness: tripMoon?.moon_brightness || ''
        });
      }
      return out;
    }

    const DRIVE_THUMB_SZ = 'w1200';
    function resolvePhotoUrl(raw){
      if (!raw) return '';
      let s = String(raw).trim();
      const urlInText = s.match(/https?:\/\/[^\s")]+/i);
      if (urlInText) s = urlInText[0];
      if (/^https?:\/\/(?:lh\d+\.googleusercontent\.com|drive\.google\.com\/thumbnail)/i.test(s)) return s;
      let id = null, resourceKey = null;
      const mFile = s.match(/https?:\/\/drive\.google\.com\/file\/d\/([^/]+)/i);
      if (mFile) id = mFile[1];
      const mId = s.match(/[?&]id=([^&]+)/i);
      if (!id && mId) id = mId[1];
      const mKey = s.match(/[?&]resourcekey=([^&]+)/i);
      if (mKey) resourceKey = mKey[1];
      if (!id && /^[A-Za-z0-9_-]{10,}$/.test(s) && s.indexOf('http') !== 0) id = s;
      if (id){
        let url = `https://drive.google.com/thumbnail?id=${id}&sz=${DRIVE_THUMB_SZ}`;
        if (resourceKey) url += `&resourcekey=${resourceKey}`;
        return url;
      }
      if (s.startsWith('http') || s.startsWith('data:')) return s;
      return '';
    }

    // バッジ（一覧と同じトーン）
    function pill(text, tone){
      const toneMap = {
        sky:     'border-sky-700/60 bg-sky-900/30',
        emerald: 'border-emerald-700/60 bg-emerald-900/30',
        violet:  'border-violet-700/60 bg-violet-900/30',
        slate:   'border-slate-700/60 bg-slate-800/40'
      };
      const cls = toneMap[tone] || toneMap.slate;
      return `<span class="px-2 py-0.5 rounded-full text-[11px] ${cls}">${text}</span>`;
    }

    // ラベル:値 の行
    function kv(label, value){
      if (!value && value !== 0) return '';
      return `<div class="flex justify-between gap-3 text-sm">
        <div class="text-slate-400">${label}</div>
        <div class="text-slate-200 text-right break-all">${value}</div>
      </div>`;
    }

    // 画像URL正規化（一覧で使っているものを流用）
    const resolvePhotoUrlDetail = resolvePhotoUrl;

    function renderRemoteList(items){
      // 一覧を折りたたみ(details)にし、展開中はhover無効・枠線は外枠のみ・閉じるボタン付き
      remoteCatchList.innerHTML = '';
      detailWrap.classList.add('hidden'); // 既存の独立詳細パネルは使わない

      items.forEach((it)=>{
        // ===== 外枠（折りたたみ） =====
        const wrap = document.createElement('details');
        wrap.className = 'rounded-2xl bg-slate-900 border border-slate-800 mb-2';

        // ===== サマリ（一覧部） =====
        const summary = document.createElement('summary');
        summary.className = 'list-none p-3 flex gap-3 items-start cursor-pointer rounded-2xl hover:bg-slate-800/60';

        // サムネ
        const img = document.createElement('img');
        img.className = 'w-24 h-24 object-cover rounded-xl bg-slate-950';
        img.alt = 'photo';
        img.src = resolvePhotoUrl(it.photo) || '';
        summary.appendChild(img);

        // テキスト群
        const info = document.createElement('div');
        info.className = 'flex-1 min-w-0';

        // 1行目：タイトル（魚種 / サイズ）
        const rowTitle = document.createElement('div');
        rowTitle.className = 'flex items-center justify-between gap-2';
        const title = document.createElement('div');
        title.className = 'font-semibold truncate text-lg';
        title.textContent = it.species || '(魚種不明)';
        rowTitle.appendChild(title);
        const sz = document.createElement('span');
        sz.className='text-sm text-slate-300';
        if (it.size !== '' && it.size != null) sz.textContent = String(it.size)+' cm';
        rowTitle.appendChild(sz);
        info.appendChild(rowTitle);

        // 2行目：日時 / 地点
        const rowMeta = document.createElement('div');
        rowMeta.className = 'mt-1 flex flex-wrap gap-x-4 gap-y-1 text-sm';
        const dtText = formatSheetDateTime(it.date, it.time);
        if (dtText) {
          const wrapMeta = document.createElement('span');
          const val = document.createElement('span');
          val.className = 'text-slate-200';
          val.textContent = dtText;
          wrapMeta.appendChild(val);
          rowMeta.appendChild(wrapMeta);
        }
        if (it.place) {
          const wrapMeta = document.createElement('span');
          const val = document.createElement('span');
          val.className = 'text-slate-200';
          val.textContent = it.place;
          wrapMeta.appendChild(val);
          rowMeta.appendChild(wrapMeta);
        }
        info.appendChild(rowMeta);

        // 3行目：潮バッジ
        const rowCond = document.createElement('div');
        rowCond.className = 'mt-1 flex flex-wrap items-center gap-2';
        if (it.tideName)  rowCond.insertAdjacentHTML('beforeend',  pill(it.tideName,  'sky'));
        if (it.tideTrend) rowCond.insertAdjacentHTML('beforeend',  pill(it.tideTrend, 'emerald'));
        if (it.tideLevel || it.tideLevel === 0) rowCond.insertAdjacentHTML('beforeend', pill(`${it.tideLevel} cm`, 'violet'));
        info.appendChild(rowCond);

        summary.appendChild(info);
        wrap.appendChild(summary);

        // ===== 展開部（閉じるボタン付き・内側は枠線ナシでシンプル） =====
        const detail = document.createElement('div');
        detail.className = 'px-3 pb-3';
        detail.innerHTML = `
          <div class="flex items-center justify-between mt-1 mb-2">
            <div class="text-xs text-slate-400">詳細</div>
            <button type="button" data-role="catch-detail-close"
              class="text-xs px-2 py-1 rounded-lg border border-slate-700 hover:bg-slate-800">
              閉じる
            </button>
          </div>

          <div class="grid sm:grid-cols-2 gap-4 mt-1">
            <div>
              <img
                src="${resolvePhotoUrlDetail(it.photo) || ''}"
                alt="photo"
                class="w-full h-auto max-h-[70vh] object-contain rounded-xl bg-slate-900"
              />
            </div>
            <div class="space-y-3">
              <div class="rounded-xl bg-slate-800/30 p-3 space-y-1">
                <div class="text-xs text-slate-400">基本情報</div>
                ${kv('魚種', it.species || '')}
                ${kv('サイズ', (it.size || it.size===0) ? `${it.size} cm` : '')}
                ${kv('重量', (it.weight || it.weight===0) ? `${it.weight} g` : '')}
                ${kv('方法', it.method || '')}
              </div>

              ${(it.place || it.lat || it.lng) ? `
                <div class="rounded-xl bg-slate-800/30 p-3 space-y-1">
                  <div class="text-xs text-slate-400">位置</div>
                  ${kv('地点', it.place || '')}
                  ${kv('緯度', it.lat || '')}
                  ${kv('経度', it.lng || '')}
                </div>` : ''}

              ${(it.tideName || it.tideTrend || (it.tideLevel || it.tideLevel===0) || it.tide_high_times || it.tide_low_times) ? `
                <div class="rounded-xl bg-slate-800/30 p-3 space-y-1">
                  <div class="text-xs text-slate-400">潮</div>
                  <div class="flex flex-wrap items-center gap-2 mb-1">
                    ${it.tideName  ? pill(it.tideName, 'sky') : ''}
                    ${it.tideTrend ? pill(it.tideTrend, 'emerald') : ''}
                    ${(it.tideLevel || it.tideLevel===0) ? pill(`${it.tideLevel} cm`, 'violet') : ''}
                  </div>
                  ${kv('満潮', it.tide_high_times || '')}
                  ${kv('干潮', it.tide_low_times  || '')}
                </div>` : ''}

              ${it.notes ? `
                <div class="rounded-xl bg-slate-800/30 p-3">
                  <div class="text-xs text-slate-400 mb-1">メモ</div>
                  <div class="text-sm text-slate-200 whitespace-pre-line">${it.notes}</div>
                </div>` : ''}
            </div>
          </div>
        `;
        wrap.appendChild(detail);

        // 「閉じる」ボタンでこの details を閉じる
        detail.querySelector('[data-role="catch-detail-close"]').onclick = (e)=>{
          e.stopPropagation();
          wrap.open = false;
        };

        // 開閉で hover を制御（開いている間は hover 無効）
        wrap.addEventListener('toggle', () => {
          if (wrap.open) summary.classList.remove('hover:bg-slate-800/60');
          else summary.classList.add('hover:bg-slate-800/60');
        });

        remoteCatchList.appendChild(wrap);
      });
    }

    function showDetail(it){
      const wrap = document.getElementById('remoteCatchDetail');
      const body = document.getElementById('detailBody');

      const title = `
        <div class="flex items-start justify-between gap-3">
          <div class="font-semibold text-2xl tracking-tight">${it.species || '(魚種不明)'}</div>
          <div class="text-slate-200">${(it.size || it.size===0) ? `${it.size} cm` : ''}</div>
        </div>
      `;

      const timeText = formatSheetDateTime(it.date, it.time);
      const meta = `
        <div class="text-sm text-slate-300 flex flex-wrap gap-x-4 gap-y-1">
          ${timeText ? `<span>${timeText}</span>` : ''}
          ${it.place   ? `<span>${it.place}</span>` : ''}
        </div>
      `;

      const cond = `
        <div class="mt-1 flex flex-wrap items-center gap-2">
          ${it.tideName  ? pill(it.tideName, 'sky') : ''}
          ${it.tideTrend ? pill(it.tideTrend, 'emerald') : ''}
          ${(it.tideLevel || it.tideLevel===0) ? pill(`${it.tideLevel} cm`, 'violet') : ''}
        </div>
      `;

      const img = `
        <img
          src="${resolvePhotoUrlDetail(it.photo) || ''}"
          alt="photo"
          class="w-full h-auto max-h-[70vh] object-contain rounded-xl border border-slate-800 bg-slate-900"
        />
      `;

      const basicCard = `
        <div class="rounded-2xl bg-slate-900 border border-slate-800 p-3 space-y-2">
          <div class="text-xs text-slate-400">基本情報</div>
          ${kv('魚種', it.species || '')}
          ${kv('サイズ', (it.size || it.size===0) ? `${it.size} cm` : '')}
          ${kv('重量', (it.weight || it.weight===0) ? `${it.weight} g` : '')}
          ${kv('方法', it.method || '')}
        </div>
      `;

      const posCard = (it.place || it.lat || it.lng) ? `
        <div class="rounded-2xl bg-slate-900 border border-slate-800 p-3 space-y-2">
          <div class="text-xs text-slate-400">位置</div>
          ${kv('地点', it.place || '')}
          ${kv('緯度', it.lat || '')}
          ${kv('経度', it.lng || '')}
        </div>
      ` : '';

      const tideCard = (it.tideName || it.tideTrend || (it.tideLevel || it.tideLevel===0) || it.tide_high_times || it.tide_low_times) ? `
        <div class="rounded-2xl bg-slate-900 border border-slate-800 p-3 space-y-2">
          <div class="text-xs text-slate-400">潮</div>
          <div class="flex flex-wrap items-center gap-2">
            ${it.tideName  ? pill(it.tideName, 'sky') : ''}
            ${it.tideTrend ? pill(it.tideTrend, 'emerald') : ''}
            ${(it.tideLevel || it.tideLevel===0) ? pill(`${it.tideLevel} cm`, 'violet') : ''}
          </div>
          ${kv('満潮', slashAligned(it.tide_high_times))}
          ${kv('干潮', slashAligned(it.tide_low_times))}
        </div>
      ` : '';

      // 追加: 月情報カード（Trips から）
      const moonCard = (it.moon_visual || it.moon_age || it.moon_brightness) ? `
        <div class="rounded-2xl bg-slate-900 border border-slate-800 p-3 space-y-2">
          <div class="text-xs text-slate-400">月</div>
          ${kv('見え方', it.moon_visual || '')}
          ${kv('月齢', it.moon_age || '')}
        </div>
      ` : '';

      const notesCard = it.notes ? `
        <div class="rounded-2xl bg-slate-900 border border-slate-800 p-3">
          <div class="text-xs text-slate-400 mb-1">メモ</div>
          <div class="text-sm text-slate-200 whitespace-pre-line">${it.notes}</div>
        </div>
      ` : '';

      body.innerHTML = `
        ${title}
        ${meta}
        ${cond}
        <div class="grid sm:grid-cols-2 gap-4 mt-2">
          <div>${img}</div>
          <div class="space-y-3">
            ${basicCard}
            ${posCard}
            ${tideCard}
            ${moonCard}
          </div>
        </div>
        ${notesCard}
      `;

      wrap.classList.remove('hidden');
      wrap.scrollIntoView({behavior:'smooth', block:'start'});
    }

    // 「HH:MM／HH:MM」をスラッシュで揃えて表示
    function slashAligned(val){
      if (!val) return '';
      const [aRaw='', bRaw=''] = String(val).split('／');
      const a = (aRaw || '').trim() || '－';
      const b = (bRaw || '').trim() || '－';
      // 左右を別カラム、中央にスラッシュ。等幅数字で桁揃え
      return `
        <span class="inline-grid grid-cols-[1fr_auto_1fr] items-baseline gap-1 tabular-nums">
          <span class="text-right">${a}</span>
          <span>／</span>
          <span class="text-left">${b}</span>
        </span>
      `;
    }


    // ===== 釣行ドラフト =====
    const LS_KEY='fishtrip_draft_v1';
    const uuid = ()=> (crypto?.randomUUID ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2,10)));
    const loadDraft = () => {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) {
          return { tripId: uuid(), status: 'idle', catches: [], tide_daily_cache: {} };
        }
        const p = JSON.parse(raw);
        return {
          tripId: p.tripId || uuid(),
          status: p.status || 'idle',
          catches: p.catches || [],
          startedAt: p.startedAt,
          endedAt: p.endedAt,
          lat: p.lat,
          lng: p.lng,
          start_weather: p.start_weather,
          end_weather: p.end_weather,
          start_tide: p.start_tide,
          tide_daily_cache: p.tide_daily_cache || {}
        };
      } catch {
        return { tripId: uuid(), status: 'idle', catches: [], tide_daily_cache: {} };
      }
    };
    const saveDraft = d => localStorage.setItem(LS_KEY, JSON.stringify(d));
    const fmtLocal = iso => { try{return new Date(iso).toLocaleString();}catch{return '—'}; };

    let draft = loadDraft();
    let catchForm = { id: uuid(), timestamp: nowIsoLocal(), species:'', size_cm:null, weight_g:null, method:'', photoPreviewUrl:undefined };
    let editMode=false, editingId=null;

    // 終了確認モーダル用
    let pendingEnd = null; // { endedAt: string(JST ISO), end_weather: object|null }

    // DOM参照（記録ビュー）
    const txtStatus=document.getElementById('txtStatus');
    const txtTripId=document.getElementById('txtTripId');
    const txtPosWrap=document.getElementById('txtPos');
    const txtLat=document.getElementById('txtLat');
    const txtLng=document.getElementById('txtLng');
    const txtStartedAt=document.getElementById('txtStartedAt');
    const txtCatchCount=document.getElementById('txtCatchCount');
    const tripWeatherRow=document.getElementById('tripWeatherRow');
    const buttonRow=document.getElementById('buttonRow');
    const bottomBar=document.getElementById('bottomBar');
    const btnAddCatchBottom=document.getElementById('btnAddCatchBottom');
    const btnEndBottom=document.getElementById('btnEndBottom');

    const catchListEmpty=document.getElementById('catchListEmpty');
    const hintAddWhenActive=document.getElementById('hintAddWhenActive');
    const catchList=document.getElementById('catchList');

    const catchModal=document.getElementById('catchModal');
    const btnCloseModal=document.getElementById('btnCloseModal');
    const btnCancelCatch=document.getElementById('btnCancelCatch');
    const btnSaveCatch=document.getElementById('btnSaveCatch');
    const inpCatchTime=document.getElementById('inpCatchTime');
    const inpSpecies=document.getElementById('inpSpecies');
    const inpSize=document.getElementById('inpSize');
    const inpWeight=document.getElementById('inpWeight');
    const inpMethod=document.getElementById('inpMethod');
    const inpPhoto=document.getElementById('inpPhoto');
    const imgPreview=document.getElementById('imgPreview');
    const modalTitle=document.getElementById('modalTitle');

    // 画像アップロード
    const UPLOAD_ENDPOINT = "https://script.google.com/macros/s/AKfycbzCFeNSe6kn6GFvXBvysAs9sGFrZLguidOxFPTLnMMUHZOSJGosTUuOA0q-p6A2ZPik/exec";
    function fileToDataURL(file){
      return new Promise((res, rej)=>{
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
      });
    }
    async function uploadPhotoToDrive(file){
      const dataUrl = await fileToDataURL(file);
      const payload = {
        action: "uploadPhoto",
        fileName: file.name || (`photo_${Date.now()}.jpg`),
        mimeType: file.type || "image/jpeg",
        dataUrl
      };
      const res = await fetch(UPLOAD_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=UTF-8" },
        body: JSON.stringify(payload)
      });
      const j = await res.json().catch(()=> ({}));
      if (!res.ok || !j?.ok) throw new Error(j?.error || `HTTP ${res.status}`);
      return j; // { ok:true, fileId, viewUrl, thumbUrl }
    }

    // ===== 潮汐：Worker プロキシ =====
    const TIDE_PROXY_URL = "https://jolly-voice-b254.yuji-fallline2999m.workers.dev"; // ←置き換え必須

    // 港コード一覧（GViz）読み込みキャッシュ
    let harborCache = null;

    async function loadHarborsFromSheet(){
      if (harborCache) return harborCache;
      const rows = await loadGVizViaJSONP(SHEET_ID, HARBOR_SHEET_NAME);
      if (!rows || rows.length < 2) throw new Error("港コード一覧のデータが見つかりません");
      const headers = rows[0].map(h=>String(h||'').trim());
      const findCol = (cands) => {
        const idx = headers.findIndex(h => cands.some(c => h.toLowerCase().includes(c)));
        return idx >= 0 ? idx : null;
      };
      const idxPC = findCol(['pc','pref','都道府県コード','県コード']) ?? 0;
      const idxHC = findCol(['hc','harbor','港コード','港id']) ?? 1;
      const idxPN = findCol(['pn','pref','都道府県名']) ?? 2;
      const idxHN = findCol(['hn','港名','harbor']) ?? 3;
      const idxLAT= findCol(['lat','緯度']) ?? 4;
      const idxLON= findCol(['lon','lng','経度']) ?? 5;

      const mapped = [];
      for (let i=1; i<rows.length; i++){
        const r = rows[i];
        const pc = r[idxPC]; const hc = r[idxHC];
        const pn = r[idxPN]; const hn = r[idxHN];
        const lat= parseFloat(r[idxLAT]); const lon=parseFloat(r[idxLON]);
        if (!isFinite(lat) || !isFinite(lon)) continue;
        mapped.push({ pc, hc, pn, hn, lat, lon });
      }
      harborCache = { headers, rows, mapped };
      LOG.tide("harbors loaded:", mapped.length);
      return harborCache;
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const toRad = deg => (deg * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.asin(Math.sqrt(a));
    }

    async function findNearestHarbor(lat, lon, radiusKm = 10){
      const hc = await loadHarborsFromSheet();
      const candidates = hc.mapped
        .map(h => ({ ...h, dist: haversineDistance(lat, lon, h.lat, h.lon) }))
        .filter(h => h.dist <= radiusKm)
        .sort((a,b)=> a.dist - b.dist);
      return candidates[0] || null;
    }

    function toSeconds_HHMM(timeStr) {
      if (timeStr === "24:00") timeStr = "23:59";
      const [h, m] = timeStr.split(":").map(Number);
      return h * 3600 + m * 60;
    }

    function analyzeTideTrendForTime(chart, localDate){
      try{
        const tideList = chart?.tide;
        if (!tideList || tideList.length < 2) return "不明";
        const heights = tideList.map(t => t.cm);
        const min = Math.min(...heights);
        const max = Math.max(...heights);
        const range = max - min;
        if (!isFinite(range) || range <= 0) return "不明";

        const hh = localDate.getHours();
        const mm = localDate.getMinutes();
        const shotSec = hh*3600 + mm*60;

        let closest = tideList[0];
        let closestDiff = Math.abs(toSeconds_HHMM(closest.time) - shotSec);
        for (let i=1; i<tideList.length; i++){
          const sec = toSeconds_HHMM(tideList[i].time);
          const diff = Math.abs(sec - shotSec);
          if (diff < closestDiff){ closest = tideList[i]; closestDiff = diff; }
        }
        const idx = tideList.indexOf(closest);
        const prev = tideList[idx-1];
        const next = tideList[idx+1];
        if (!prev || !next) return "不明";

        const trend = next.cm > prev.cm ? "上げ潮" : "下げ潮";
        const level = Math.round(((closest.cm - min) / range) * 10);
        return `${trend}（${level}分）`;
      }catch{ return "不明"; }
    }

    // === その日の満潮/干潮の時刻を抽出（最大2つずつ） ===
    function summarizeHighLowTimesFromChart(chart){
      const list = Array.isArray(chart?.tide) ? chart.tide : [];
      if (list.length < 3) return { high:null, low:null };

      const pts = list
        .map(p => ({ t: timeStrToMinutes(p.time), cm: Number(p.cm) }))
        .filter(p => isFinite(p.cm))
        .sort((a,b)=> a.t - b.t);

      const highs = [];
      const lows  = [];
      for (let i=1;i<pts.length-1;i++){
        const a = pts[i-1], b = pts[i], c = pts[i+1];
        if (a.cm < b.cm && b.cm > c.cm) highs.push(pts[i].t);
        if (a.cm > b.cm && b.cm < c.cm) lows.push(pts[i].t);
      }

      const toHHMM = (m)=> `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
      const fmt = (arr) => {
        const xs = arr.slice(0, 2).map(toHHMM);
        if (xs.length === 0) return null;    // その日なし
        if (xs.length === 1) xs.push('－');  // 片方しか無い → 「HH:MM／－」
        return xs.join('／');
      };
      return { high: fmt(highs), low: fmt(lows) };
    }

    // === 指定日のチャート取得（キャッシュ付） ===
    const tideChartCache = {};
    async function getTideChartForDate(lat, lon, isoWithOffset){
      if (!TIDE_PROXY_URL || TIDE_PROXY_URL.includes("your-worker")) return null;
      const harbor = await findNearestHarbor(lat, lon, 10);
      if (!harbor) return null;

      const d = new Date(isoWithOffset);
      const y = d.getFullYear();
      const m = d.getMonth() + 1;
      const da = d.getDate();
      const keyDate = `${y}-${String(m).padStart(2,'0')}-${String(da).padStart(2,'0')}`;
      const cacheKey = `${harbor.pc}-${harbor.hc}-${keyDate}`;
      if (tideChartCache[cacheKey]) {
        return { harbor, chart: tideChartCache[cacheKey], chartDateKey: keyDate };
      }

      const url = `${TIDE_PROXY_URL}?pc=${encodeURIComponent(harbor.pc)}&hc=${encodeURIComponent(harbor.hc)}&yr=${y}&mn=${m}&dy=${da}&rg=day`;
      let tideJson=null;
      try{
        const res = await fetch(url);
        if (!res.ok) return null;
        tideJson = await res.json();
      }catch{ return null; }

      const chartAll = tideJson?.tide?.chart;
      if (!chartAll) return null;
      const chart = chartAll[keyDate] || chartAll[`${y}-${m}-${da}`] || chartAll[Object.keys(chartAll).sort().reverse()[0]];
      if (!chart) return null;

      tideChartCache[cacheKey] = chart;
      return { harbor, chart, chartDateKey: keyDate };
    }

    // === 釣果時刻の潮位(cm)と傾向 ===
    function nearestTideLevelCm(chart, localDate){
      const list = Array.isArray(chart?.tide) ? chart.tide : [];
      if (!list.length) return null;
      const target = localDate.getHours()*60 + localDate.getMinutes();
      let best = list[0], diff = Math.abs(timeStrToMinutes(best.time)-target);
      for (let i=1;i<list.length;i++){
        const d = Math.abs(timeStrToMinutes(list[i].time)-target);
        if (d < diff){ best = list[i]; diff = d; }
      }
      const cm = Number(best.cm);
      return isFinite(cm) ? Math.round(cm) : null;
    }

    function dateKeyFromIso(iso){
      const d = new Date(iso);
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }

    function tideInfoFromChart(chart, isoWithOffset){
      const localDate = new Date(isoWithOffset);
      const level_cm = nearestTideLevelCm(chart, localDate);
      const trend_text = analyzeTideTrendForTime(chart, localDate);
      return { level_cm, trend_text };
    }

    // ===== 開始時の潮 =====
    async function fetchTideForStart(lat, lon, startedAtIso){
      if (!TIDE_PROXY_URL || TIDE_PROXY_URL.includes("your-worker")) {
        LOG.tide("TIDE_PROXY_URL が未設定のためスキップ");
        return null;
      }
      const harbor = await findNearestHarbor(lat, lon, 10);
      if (!harbor) { LOG.tide("近傍港が見つかりません"); return null; }

      const d = new Date(startedAtIso);
      const yr = d.getFullYear();
      const mn = d.getMonth() + 1;
      const dy = d.getDate();

      const url = `${TIDE_PROXY_URL}?pc=${encodeURIComponent(harbor.pc)}&hc=${encodeURIComponent(harbor.hc)}&yr=${yr}&mn=${mn}&dy=${dy}&rg=day`;
      LOG.tide("fetch:", url);

      let tideJson = null;
      try{
        const res = await fetch(url);
        if (!res.ok){ LOG.tide("tide http error", res.status); return null; }
        tideJson = await res.json();
      }catch(e){
        LOG.tide("tide fetch failed", e?.message || e);
        return null;
      }

      const chartAll = tideJson?.tide?.chart && typeof tideJson.tide.chart === 'object' ? tideJson.tide.chart : null;
      if (!chartAll) { LOG.tide("no chart in response"); return null; }

      const key1 = `${yr}-${mn}-${dy}`;
      const key2 = `${yr}-${String(mn).padStart(2,'0')}-${String(dy).padStart(2,'0')}`;
      let chartDateKey = null;
      let chart = null;
      if (chartAll[key1]) { chartDateKey = key1; chart = chartAll[key1]; }
      else if (chartAll[key2]) { chartDateKey = key2; chart = chartAll[key2]; }
      else {
        const keys = Object.keys(chartAll).sort().reverse();
        chartDateKey = keys[0] || null;
        chart = chartDateKey ? chartAll[chartDateKey] : null;
      }
      if (!chart) { LOG.tide("chart not found even after fallback"); return null; }

      const tideName = chart?.moon?.title || "不明";
      const sunrise  = chart?.sun?.rise || "不明";
      const sunset   = chart?.sun?.set  || "不明";
      const trendText= analyzeTideTrendForTime(chart, d);

      return {
        harbor: { pc: harbor.pc, hc: harbor.hc, pn: harbor.pn, hn: harbor.hn, lat: harbor.lat, lon: harbor.lon, dist_km: harbor.dist },
        tideName, sunrise, sunset, trendText,
        chartDateKey,
        chart
      };
    }

    function timeStrToMinutes(t){
      if (!t) return 0;
      if (t === "24:00") return 24*60;
      const [h,m] = t.split(":").map(n=>parseInt(n,10));
      return (isFinite(h)?h:0)*60 + (isFinite(m)?m:0);
    }

    function drawTideChartOnCanvas(canvas, chart){
      const ctx = canvas.getContext('2d');
      const W = 720, H = 260;
      canvas.width = W; canvas.height = H;

      const padding = { left: 48, right: 16, top: 16, bottom: 28 };
      const innerW = W - padding.left - padding.right;
      const innerH = H - padding.top - padding.bottom;

      const tideList = Array.isArray(chart?.tide) ? chart.tide : [];
      if (!tideList.length){
        ctx.clearRect(0,0,W,H);
        ctx.fillStyle = "#94a3b8";
        ctx.font = "12px sans-serif";
        ctx.fillText("この日の潮汐データがありません", 16, 24);
        return;
      }

      const points = tideList.map(p => ({
        xMin: Math.max(0, Math.min(1440, timeStrToMinutes(p.time))),
        cm: Number(p.cm)
      })).filter(p => isFinite(p.cm));

      const ys = points.map(p=>p.cm);
      let minY = Math.min(0, Math.min(...ys));
      let maxY = Math.max(0, Math.max(...ys));
      if (minY === maxY){ minY -= 10; maxY += 10; }

      const mapX = (min) => padding.left + (min/1440) * innerW;
      const mapY = (cm)  => padding.top + (maxY - cm) / (maxY - minY) * innerH;

      ctx.clearRect(0,0,W,H);
      ctx.fillStyle = "#0f172a";
      ctx.fillRect(0,0,W,H);

      ctx.strokeStyle = "#1e293b";
      ctx.lineWidth = 1;
      ctx.beginPath();
      for (let h=0; h<=24; h+=3){
        const x = mapX(h*60);
        ctx.moveTo(x, padding.top);
        ctx.lineTo(x, H - padding.bottom);
      }
      ctx.stroke();

      const yZero = mapY(0);
      ctx.strokeStyle = "#64748b";
      ctx.lineWidth = 1.5;
      ctx.setLineDash([4,4]);
      ctx.beginPath();
      ctx.moveTo(padding.left, yZero);
      ctx.lineTo(W - padding.right, yZero);
      ctx.stroke();
      ctx.setLineDash([]);

      ctx.strokeStyle = "#334155";
      ctx.lineWidth = 1;
      ctx.strokeRect(padding.left, padding.top, innerW, innerH);

      ctx.strokeStyle = "#38bdf8";
      ctx.lineWidth = 2;
      ctx.beginPath();
      points.forEach((p,i)=>{
        const x = mapX(p.xMin);
        const y = mapY(p.cm);
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      ctx.fillStyle = "#7dd3fc";
      points.forEach(p=>{
        const x = mapX(p.xMin);
        const y = mapY(p.cm);
        ctx.beginPath(); ctx.arc(x,y,2.2,0,Math.PI*2); ctx.fill();
      });

      ctx.fillStyle = "#cbd5e1";
      ctx.font = "11px sans-serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      [0,6,12,18,24].forEach(h=>{
        const x = mapX(h*60);
        ctx.fillText(`${String(h).padStart(2,"0")}:00`, x, H - padding.bottom + 6);
      });

      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      ctx.fillText(`${Math.round(maxY)} cm`, padding.left - 6, mapY(maxY));
      ctx.fillText(`0 cm`,              padding.left - 6, yZero);
      ctx.fillText(`${Math.round(minY)} cm`, padding.left - 6, mapY(minY));
    }

    // ===== UIレンダリング =====
    function render(){
      txtTripId.textContent = draft.tripId.slice(0,8);
      txtStatus.textContent = draft.status==='idle' ? '未開始' : (draft.status==='active' ? '釣行中' : '終了');
      txtStartedAt.textContent = draft.startedAt ? fmtLocal(draft.startedAt) : '—';
      txtCatchCount.textContent = (draft.catches?.length||0)+' 件';

      if(typeof draft.lat==='number' && typeof draft.lng==='number'){
        txtPosWrap.classList.remove('hidden'); txtLat.textContent=draft.lat.toFixed(5); txtLng.textContent=draft.lng.toFixed(5);
      }else{
        txtPosWrap.classList.add('hidden');
      }

      tripWeatherRow.innerHTML = '';
      const box = (label, val) => {
        const d=document.createElement('div');
        d.className='rounded-xl bg-slate-800/40 p-3';
        d.innerHTML = `<div class="text-xs text-slate-400">${label}</div>
                       <div class="text-sm text-slate-200 mt-0.5">${val || '—'}</div>`;
        return d;
      };
      const wxBrief = draft.start_weather ? formatWeatherBrief(draft.start_weather) : null;
      tripWeatherRow.appendChild(box('開始時の天気', wxBrief));

      const tideBrief = draft.start_tide ? `${draft.start_tide.tideName} / ${draft.start_tide.trendText}` : null;
      tripWeatherRow.appendChild(box('開始時の潮', tideBrief));

      buttonRow.innerHTML='';
      if (draft.status==='idle'){
        const b=document.createElement('button'); b.textContent='釣行開始';
        b.className='flex-1 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 font-semibold';
        b.onclick=startTrip; buttonRow.appendChild(b);
      } else if (draft.status==='active'){
        const b1=document.createElement('button'); b1.textContent='＋釣果';
        b1.className='flex-1 py-2 rounded-xl bg-sky-600 hover:bg-sky-500 font-semibold';
        b1.onclick=openAddCatch;
        const b2=document.createElement('button'); b2.textContent='釣行終了';
        b2.className='flex-1 py-2 rounded-xl bg-rose-600 hover:bg-rose-500 font-semibold';
        b2.onclick=openTripReview;
        buttonRow.appendChild(b1); buttonRow.appendChild(b2);
      } else {
        const b=document.createElement('button'); b.textContent='新しく始める';
        b.className='flex-1 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-semibold';
        b.onclick = () => {draft = { tripId: uuid(), status: 'idle', catches: [], tide_daily_cache: {} };saveDraft(draft);render();};
        buttonRow.appendChild(b);
      }
      if (draft.status==='active'){ bottomBar.classList.remove('hidden'); hintAddWhenActive.classList.remove('hidden'); }
      else { bottomBar.classList.add('hidden'); hintAddWhenActive.classList.add('hidden'); }

      // 釣果リスト
      catchList.innerHTML='';
      const has = draft.catches && draft.catches.length>0;
      catchListEmpty.classList.toggle('hidden', has);
      if (has){
        draft.catches.forEach(c=>{
          const li=document.createElement('li'); li.className='rounded-xl bg-slate-900 border border-slate-800 p-3 flex gap-3';
          const thumbSrc = c.photoDriveThumbUrl || c.photoDriveUrl || c.photoPreviewUrl || "";
          let thumb;
          if (thumbSrc){
            thumb=document.createElement('img'); thumb.src=thumbSrc; thumb.alt='catch'; thumb.className='w-20 h-20 object-cover rounded-lg border border-slate-800';
          } else {
            thumb=document.createElement('div'); thumb.className='w-20 h-20 rounded-lg border border-dashed border-slate-700 grid place-items-center text-xs text-slate-500'; thumb.textContent='No Photo';
          }
          li.appendChild(thumb);

          const info=document.createElement('div'); info.className='flex-1 min-w-0';
          const row1=document.createElement('div'); row1.className='flex items-center justify-between';
          const title=document.createElement('div'); title.className='font-semibold truncate'; title.textContent=c.species||'(魚種未設定)';
          const tm=document.createElement('div'); tm.className='text-xs text-slate-400 ml-2'; try{ tm.textContent=new Date(c.timestamp).toLocaleTimeString(); }catch{ tm.textContent=''; }
          row1.appendChild(title); row1.appendChild(tm);

          const row2=document.createElement('div'); row2.className='text-sm text-slate-300 mt-1 flex flex-wrap gap-x-3 gap-y-1';
          if (c.size_cm!=null){ const sp=document.createElement('span'); sp.textContent='サイズ: '+c.size_cm+' cm'; row2.appendChild(sp); }
          if (c.weight_g!=null){ const sp=document.createElement('span'); sp.textContent='重量: '+c.weight_g+' g'; row2.appendChild(sp); }
          if (c.method){ const sp=document.createElement('span'); sp.textContent='方法: '+c.method; row2.appendChild(sp); }

          if (c.weather) {
            const rowWx = document.createElement('div');
            rowWx.className = 'text-xs text-slate-400 mt-1';
            rowWx.textContent = formatWeatherBrief(c.weather);
            info.appendChild(rowWx);
          }

          info.appendChild(row1); info.appendChild(row2);

          const ops=document.createElement('div'); ops.className='flex flex-col gap-1 shrink-0';
          const btnEdit=document.createElement('button'); btnEdit.className='px-2 py-1 text-xs rounded-lg border border-slate-700 hover:bg-slate-800'; btnEdit.textContent='編集';
          btnEdit.onclick=()=>openEditCatch(c.id);
          const btnDel=document.createElement('button'); btnDel.className='px-2 py-1 text-xs rounded-lg border border-slate-700 hover:bg-slate-800'; btnDel.textContent='削除';
          btnDel.onclick=()=>{ draft.catches = draft.catches.filter(x=>x.id!==c.id); saveDraft(draft); render(); };
          ops.appendChild(btnEdit); ops.appendChild(btnDel);

          li.appendChild(info); li.appendChild(ops);
          catchList.appendChild(li);
        });
      }
    }
        // ===== 釣行の確認（Trips） =====
    const tripListEl = document.getElementById('tripList');
    const tripStatus = document.getElementById('tripStatus');
    const tripDetailWrap = document.getElementById('tripDetail');
    const tripDetailBody = document.getElementById('tripDetailBody');
    const btnCloseTripDetail = document.getElementById('btnCloseTripDetail');

    btnCloseTripDetail.onclick = () => tripDetailWrap.classList.add('hidden');

    let tripsCache = null;     // [[headers], row...]
    let catchesCache = null;   // [[headers], row...]

    function autoLoadTrips(){ if (!tripsCache) loadTrips(); }

    async function loadTrips(){
      try{
        tripStatus.textContent = '読込中...';
        tripListEl.innerHTML = '';
        tripDetailWrap.classList.add('hidden');
        tripsCache = await loadGVizViaJSONP(SHEET_ID, TRIPS_SHEET_NAME);
        if (!tripsCache || tripsCache.length < 2){
          tripStatus.textContent = 'Trips にデータが見つかりません';
          return;
        }
        renderTripsList(tripsCache);
        tripStatus.textContent = `読み込み完了：${tripsCache.length-1}件`;
      }catch(e){
        console.error(e);
        tripStatus.textContent = `読込失敗: ${e.message||e}`;
      }
    }

    function hIdx(headers, name){
      const i = headers.findIndex(h => String(h||'').trim() === name);
      return i >= 0 ? i : -1;
    }

   function renderTripsList(rows){
      // --- helpers（この関数内だけ） ---
      const pad2 = n => String(n).padStart(2,'0');
      const fmtYMD = iso => {
        const d = new Date(iso); if (isNaN(d)) return '—';
        return `${d.getFullYear()}年${pad2(d.getMonth()+1)}月${pad2(d.getDate())}日`;
      };
      // "20日 04:45" のような文字列にも対応して最初の HH:MM を抜き出す
      const hm = s => {
        const m = String(s||'').match(/(\d{1,2}):(\d{2})/);
        return m ? `${pad2(m[1])}:${m[2]}` : '';
      };
      const hIdx = (hs, key) => hs.findIndex(h => String(h||'').trim() === key);

      const headers = rows[0];
      const col = {
        tripId:     hIdx(headers,'tripId'),
        startedAt:  hIdx(headers,'startedAt'),
        endedAt:    hIdx(headers,'endedAt'),
        catches:    hIdx(headers,'catches_count'),
        moon_v:     hIdx(headers,'moon_visual'),
        moon_a:     hIdx(headers,'moon_age'),
        sunrise:    hIdx(headers,'sunrise'),
        sunset:     hIdx(headers,'sunset'),
        raw_json:   hIdx(headers,'raw_json'),
      };

      tripListEl.innerHTML = '';

      for (let i=1;i<rows.length;i++){
        const r = rows[i];

        const thisTripId = col.tripId>=0 ? (r[col.tripId] || '') : '';
        const started = col.startedAt>=0 ? (r[col.startedAt] || '') : '';
        const ended   = col.endedAt>=0   ? (r[col.endedAt]   || '') : '';
        const count   = Number(col.catches>=0 ? (r[col.catches] || 0) : 0);

        const moonV = col.moon_v>=0 ? (r[col.moon_v] || '') : '';
        const moonA = col.moon_a>=0 ? (r[col.moon_a] || '') : '';

        // 追加情報（潮名 / 日の出・日の入り / 開始時の天気）
        let tideName = '';
        let sunrise  = (col.sunrise>=0 ? (r[col.sunrise] || '') : '');
        let sunset   = (col.sunset>=0  ? (r[col.sunset]  || '') : '');
        let startWeatherBrief = '';

        try{
          const raw = (col.raw_json>=0 && r[col.raw_json]) ? JSON.parse(r[col.raw_json]) : null;

          if (!sunrise || !sunset){
            sunrise = sunrise || raw?.start_tide?.sunrise || raw?.start_tide?.chart?.sun?.rise || '';
            sunset  = sunset  || raw?.start_tide?.sunset  || raw?.start_tide?.chart?.sun?.set  || '';
          }
          tideName = raw?.start_tide?.tideName || raw?.start_tide?.chart?.moon?.title || '';
          if (raw?.start_weather) startWeatherBrief = formatWeatherBrief(raw.start_weather);
        }catch(_){}

        // === 折りたたみ型カード ===
        const wrap = document.createElement('details');
        wrap.className = 'rounded-2xl bg-slate-900 border border-slate-800 mb-2';

        // summary（一覧ヘッダ部）
        const summary = document.createElement('summary');
        summary.className = 'list-none p-3 flex items-center justify-between hover:bg-slate-800/60 cursor-pointer rounded-2xl';

        const left = document.createElement('div');
        left.className = 'min-w-0';
        left.innerHTML = `
          <div class="text-slate-200 font-medium flex flex-wrap gap-x-4 gap-y-1 items-center">
            <span>${started ? fmtYMD(started) : (ended ? fmtYMD(ended) : '—')}</span>
            ${tideName ? `${pill(tideName,'sky')}` : ''}
            ${moonV ? `<span class="text-xl leading-none">${moonV}</span>` : ''}
            ${(moonA||moonA===0) ? `<span class="text-slate-300 text-sm">月齢 <span class="text-slate-100">${moonA}</span></span>` : ''}
          </div>
          <div class="text-sm text-slate-300 mt-1 flex items-center gap-2">
            ${sunrise  ? `<span class="text-slate-400">日の出</span><span class="text-slate-200">${hm(sunrise)}</span>` : ''}
            ${sunset   ? `<span class="text-slate-400">日の入り</span><span class="text-slate-200">${hm(sunset)}</span>` : ''}
          </div>
          ${startWeatherBrief ? `<div class="text-sm text-slate-300 mt-2">${startWeatherBrief}</div>` : ''}
        `;

        const right = document.createElement('div');
        right.className = 'text-sm text-slate-200 shrink-0';
        right.textContent = `釣果：${isFinite(count)?count:0}匹`;

        summary.appendChild(left);
        summary.appendChild(right);
        wrap.appendChild(summary);

        // 展開ボディ（閉じるボタン付き）
        const detail = document.createElement('div');
        detail.className = 'px-3 pb-3';
        detail.innerHTML = `
          <div class="flex items-center justify-between mt-1 mb-2">
            <div class="text-xs text-slate-400">この釣行の釣果</div>
            <button type="button" data-role="trip-detail-close"
              class="text-xs px-2 py-1 rounded-lg border border-slate-700 hover:bg-slate-800">
              閉じる
            </button>
          </div>
          <div class="text-sm text-slate-400" data-role="trip-catches-loading">読み込み中...</div>
          <div class="grid md:grid-cols-2 gap-3 mt-2" data-role="trip-catches-list"></div>
        `;
        wrap.appendChild(detail);

        // 「閉じる」ボタンでこの details を閉じる
        detail.querySelector('[data-role="trip-detail-close"]').onclick = (e)=>{
          e.stopPropagation();
          wrap.open = false;
        };

        // 開閉に合わせて hover を無効/有効化
        wrap.addEventListener('toggle', () => {
          if (wrap.open) summary.classList.remove('hover:bg-slate-800/60');
          else summary.classList.add('hover:bg-slate-800/60');
        });

        // 開いた時に Catches シートから tripId で該当釣果を読み込み
        wrap.addEventListener('toggle', async () => {
          if (!wrap.open) return;

          const listEl = detail.querySelector('[data-role="trip-catches-list"]');
          const loadingEl = detail.querySelector('[data-role="trip-catches-loading"]');
          if (listEl.dataset.loaded === '1') return; // 二重ロード防止

          try{
            const rowsC = await loadGVizViaJSONP(SHEET_ID, 'Catches');
            const hs = rowsC[0].map(h=>String(h||'').trim());
            const cTrip   = hs.indexOf('tripId');
            const cSpec   = hs.indexOf('species');
            const cTime   = hs.indexOf('timestamp');
            const cSize   = hs.indexOf('size_cm');
            const cUrl    = hs.indexOf('photo_view_url');
            const cThumb  = hs.indexOf('photo_thumb_url');
            const cTrend  = hs.indexOf('tide_trend');
            const cTideLv = hs.indexOf('tide_level_cm');

            const items = [];
            for (let j=1;j<rowsC.length;j++){
              const rr = rowsC[j];
              if (String(rr[cTrip]||'') !== String(thisTripId)) continue;
              items.push({
                species: rr[cSpec] || '',
                ts: rr[cTime] || '',
                size: rr[cSize] || '',
                photo: rr[cThumb] || rr[cUrl] || '',
                tideTrend: rr[cTrend] || '',
                tideLevel: rr[cTideLv]
              });
            }

            loadingEl.remove();
            if (!items.length){
              const empty = document.createElement('div');
              empty.className = 'text-sm text-slate-500';
              empty.textContent = '該当する釣果はありません。';
              listEl.appendChild(empty);
            }else{
              items.forEach(c=>{
                const card = document.createElement('div');
                // 枠線を無くして控えめな背景のみ
                card.className = 'rounded-lg bg-slate-900/60 p-3 flex gap-3 items-start';
                const img = document.createElement('img');
                img.className = 'w-20 h-20 object-cover rounded-lg bg-slate-950';
                img.src = resolvePhotoUrl(c.photo) || '';
                img.alt = 'photo';
                card.appendChild(img);

                const info = document.createElement('div');
                info.className = 'flex-1 min-w-0';
                info.innerHTML = `
                  <div class="font-semibold truncate">
                    ${c.species||'(魚種不明)'} ${c.size?`<span class="text-sm text-slate-300 ml-1">${c.size} cm</span>`:''}
                  </div>
                  <div class="text-xs text-slate-400 mt-0.5">${c.ts ? new Date(c.ts).toLocaleString() : ''}</div>
                  <div class="mt-1 flex flex-wrap items-center gap-2">
                    ${c.tideTrend ? pill(c.tideTrend,'emerald') : ''}
                    ${(c.tideLevel || c.tideLevel===0) ? pill(`${c.tideLevel} cm`, 'violet') : ''}
                  </div>
                `;
                card.appendChild(info);
                listEl.appendChild(card);
              });
              listEl.dataset.loaded = '1';
            }
          }catch(e){
            loadingEl.textContent = '読み込みに失敗しました。';
          }
        });

        tripListEl.appendChild(wrap);
      }
    }

    // 既存の一覧カード見た目に寄せて小さめカードを生成
    function renderCatchMiniCardsForTrip(tripId, catchesRows){
      const headers = catchesRows[0];
      const cidx = {
        tripId: hIdx(headers,'tripId'),
        ts:     hIdx(headers,'timestamp'),
        sp:     hIdx(headers,'species'),
        size:   hIdx(headers,'size_cm'),
        photo:  hIdx(headers,'photo_thumb_url') >=0 ? hIdx(headers,'photo_thumb_url')
              : (hIdx(headers,'photo_view_url') >=0 ? hIdx(headers,'photo_view_url') : hIdx(headers,'photo_file_id')),
        tideName:  hIdx(headers,'tide_name'),
        tideTrend: hIdx(headers,'tide_trend'),
        tideLevel: hIdx(headers,'tide_level_cm'),
      };

      const wrap = document.createElement('div');
      wrap.className = 'grid sm:grid-cols-2 gap-3';

      for (let i=1;i<catchesRows.length;i++){
        const r = catchesRows[i];
        if (String(r[cidx.tripId]||'') !== String(tripId)) continue;

        const card = document.createElement('div');
        card.className = 'rounded-xl bg-slate-900 border border-slate-800 p-3 flex gap-3 items-start';

        const img = document.createElement('img');
        img.className = 'w-20 h-20 object-cover rounded-lg border border-slate-800 bg-slate-950';
        img.alt = 'photo';
        img.src = resolvePhotoUrl(r[cidx.photo] || '') || '';
        card.appendChild(img);

        const info = document.createElement('div');
        info.className = 'min-w-0 flex-1';
        const titleRow = document.createElement('div');
        titleRow.className = 'flex items-center justify-between gap-2';

        const t = document.createElement('div');
        t.className = 'font-semibold truncate';
        t.textContent = r[cidx.sp] || '(魚種不明)';
        const sz = document.createElement('span');
        sz.className = 'text-sm text-slate-300';
        if (r[cidx.size] || r[cidx.size]===0) sz.textContent = `${r[cidx.size]} cm`;
        titleRow.appendChild(t); titleRow.appendChild(sz);
        info.appendChild(titleRow);

        const meta = document.createElement('div');
        meta.className = 'mt-1 text-sm text-slate-300';
        const ts = r[cidx.ts] ? new Date(r[cidx.ts]).toLocaleString() : '';
        meta.textContent = ts;
        info.appendChild(meta);

        const cond = document.createElement('div');
        cond.className = 'mt-1 flex flex-wrap items-center gap-2';
        const tn = r[cidx.tideName]; const tt = r[cidx.tideTrend]; const tl = r[cidx.tideLevel];
        if (tn){ const b=document.createElement('span'); b.className='px-2 py-0.5 rounded-full text-[11px] border border-sky-700/60 bg-sky-900/30'; b.textContent=tn; cond.appendChild(b); }
        if (tt){ const b=document.createElement('span'); b.className='px-2 py-0.5 rounded-full text-[11px] border border-emerald-700/60 bg-emerald-900/30'; b.textContent=tt; cond.appendChild(b); }
        if (tl||tl===0){ const b=document.createElement('span'); b.className='px-2 py-0.5 rounded-full text-[11px] border border-violet-700/60 bg-violet-900/30'; b.textContent=`${tl} cm`; cond.appendChild(b); }
        info.appendChild(cond);

        card.appendChild(info);
        wrap.appendChild(card);
      }
      return wrap;
    }

    async function showTripDetail({ headers, row, col }){
      const tripId = row[col.tripId];
      const started = row[col.startedAt] || '';
      const ended   = row[col.endedAt] || '';
      const status  = row[col.status] || '';
      const count   = row[col.catches] || 0;
      const moonV   = row[col.moon_v] || '';
      const moonB   = row[col.moon_b] || '';
      const moonA   = row[col.moon_a] || '';

      const head = `
        <div class="flex items-start justify-between gap-3">
          <div class="space-y-0.5">
            <div class="text-slate-300 text-sm">Trip: <span class="text-slate-100">${String(tripId).slice(0,8)}</span></div>
            <div class="text-slate-200">${(started?new Date(started).toLocaleString():'—')} 〜 ${(ended?new Date(ended).toLocaleString():'—')}</div>
            <div class="text-sm text-slate-300">${status} / 釣果 ${count} 件</div>
          </div>
          <div class="text-right text-2xl">${moonV||''}</div>
        </div>
        <div class="text-sm text-slate-300 mt-1 flex gap-3">
          ${(moonA||moonA===0)?`<span>月齢: <span class="text-slate-100">${moonA}</span></span>`:''}
          ${(moonB||moonB===0)?`<span>輝面比: <span class="text-slate-100">${moonB}%</span></span>`:''}
        </div>
      `;

      // Catches を読み込んで TripID でフィルタし、ミニカードで一覧化
      const catches = await ensureCatchesCache();
      let catchListHTML = '<div class="text-sm text-slate-400">釣果がありません。</div>';
      if (catches && catches.length > 1){
        const cards = renderCatchMiniCardsForTrip(tripId, catches);
        const wrap = document.createElement('div');
        wrap.appendChild(cards);
        catchListHTML = wrap.innerHTML;
      }

      tripDetailBody.innerHTML = `
        ${head}
        <div class="rounded-2xl bg-slate-900 border border-slate-800 p-3">
          <div class="text-xs text-slate-400 mb-2">この釣行の釣果</div>
          ${catchListHTML}
        </div>
      `;
      tripDetailWrap.classList.remove('hidden');
      tripDetailWrap.scrollIntoView({ behavior:'smooth', block:'start' });
    }

    // ===== アクション =====
    async function startTrip(){
      if (draft.status==='active') return;
      draft.status='active'; draft.startedAt=nowIsoLocal();

      try{
        if (navigator.geolocation){
          await new Promise(res=>{
            navigator.geolocation.getCurrentPosition(
              p => { draft.lat=p.coords.latitude; draft.lng=p.coords.longitude; res(); },
              () => res(),
              { enableHighAccuracy:true, timeout:8000 }
            );
          });
        }
        // 天気
        if (typeof draft.lat === 'number' && typeof draft.lng === 'number'){
          try { draft.start_weather = await fetchWeather(draft.lat, draft.lng); } catch(e){ console.warn("[Weather] startTrip fetch failed:", e?.message||e); }
        }
        // 潮汐（開始時の概況）
        try{
          if (typeof draft.lat === 'number' && typeof draft.lng === 'number'){
            const tide = await fetchTideForStart(draft.lat, draft.lng, draft.startedAt);
            draft.start_tide = tide || null;
            if (tide?.chart && tide?.chartDateKey){
              draft.tide_daily_cache = draft.tide_daily_cache || {};
              draft.tide_daily_cache[tide.chartDateKey] = {
                harbor: tide.harbor || null,
                chart: tide.chart
              };
            }
          }
        }catch(e){ console.warn("[Tide] startTrip fetch failed:", e?.message||e); }

      }catch(e){ console.warn("[startTrip]", e?.message||e); }
      saveDraft(draft); render();
    }

    function openAddCatch(){
      if (draft.status!=='active'){ alert('まず釣行を開始してください。'); return; }
      editMode=false; editingId=null; modalTitle.textContent='釣果を追加';
      catchForm={ id:uuid(), timestamp:nowIsoLocal(), species:'', size_cm:null, weight_g:null, method:'', photoPreviewUrl:undefined };
      try{ inpCatchTime.value = toLocalInputValue(new Date(catchForm.timestamp)); }catch{ inpCatchTime.value=''; }
      inpSpecies.value=''; inpSize.value=''; inpWeight.value=''; inpMethod.value=''; inpPhoto.value='';
      imgPreview.src=''; imgPreview.classList.add('hidden');
      catchModal.classList.remove('hidden');
    }
    function openEditCatch(id){
      const c = draft.catches.find(x=>x.id===id); if(!c) return;
      editMode=true; editingId=id; modalTitle.textContent='釣果を編集'; catchForm={...c};
      try{ inpCatchTime.value = toLocalInputValue(new Date(catchForm.timestamp)); }catch{ inpCatchTime.value=''; }
      inpSpecies.value=catchForm.species||''; inpSize.value=(catchForm.size_cm??''); inpWeight.value=(catchForm.weight_g??''); inpMethod.value=catchForm.method||'';
      inpPhoto.value=''; if (catchForm.photoPreviewUrl){ imgPreview.src=catchForm.photoPreviewUrl; imgPreview.classList.remove('hidden'); } else { imgPreview.src=''; imgPreview.classList.add('hidden'); }
      catchModal.classList.remove('hidden');
    }
    function closeCatchModal(){ catchModal.classList.add('hidden'); }

    async function submitCatch(){
      const species = inpSpecies.value.trim();
      if (!species){ alert('魚種を入力してください。'); return; }

      const whenLocal = inpCatchTime.value
        ? toOffsetIsoLocal(new Date(inpCatchTime.value))
        : nowIsoLocal();
      catchForm.timestamp = whenLocal;

      catchForm.species   = species;
      catchForm.size_cm   = inpSize.value ? Number(inpSize.value) : null;
      catchForm.weight_g  = inpWeight.value ? Number(inpWeight.value) : null;
      catchForm.method    = inpMethod.value || '';

      // 天気
      let wx = null;
      if (typeof draft.lat === 'number' && typeof draft.lng === 'number'){
        try { wx = await fetchWeather(draft.lat, draft.lng); } catch(e){}
      }
      catchForm.weather = wx;

      // --- 潮位/傾向/港名/満潮・干潮 ---
      catchForm.tide_level_cm    = null;
      catchForm.tide_trend       = null;
      catchForm.tide_name        = null;
      catchForm.tide_harbor_name = null;
      catchForm.tide_high_times  = null;
      catchForm.tide_low_times   = null;

      if (typeof draft.lat === 'number' && typeof draft.lng === 'number'){
        const dkey = dateKeyFromIso(whenLocal);
        let dayChart = null;

        if (draft.tide_daily_cache?.[dkey]?.chart){
          const chart = draft.tide_daily_cache[dkey].chart;
          const info = tideInfoFromChart(chart, whenLocal);
          catchForm.tide_level_cm    = info.level_cm;
          catchForm.tide_trend       = info.trend_text;
          catchForm.tide_name        = draft.start_tide?.tideName || null;
          catchForm.tide_harbor_name =
            draft.tide_daily_cache[dkey]?.harbor?. hn
            ?? draft.start_tide?.harbor?.hn
            ?? null;
          dayChart = chart;

        } else {
          const startKey = draft.start_tide?.chartDateKey;
          if (startKey && startKey === dkey && draft.start_tide?.chart){
            const chart = draft.start_tide.chart;
            const info = tideInfoFromChart(chart, whenLocal);
            catchForm.tide_level_cm    = info.level_cm;
            catchForm.tide_trend       = info.trend_text;
            catchForm.tide_name        = draft.start_tide?.tideName || null;
            catchForm.tide_harbor_name = draft.start_tide?.harbor?.hn ?? null;

            draft.tide_daily_cache = draft.tide_daily_cache || {};
            draft.tide_daily_cache[dkey] = {
              harbor: draft.start_tide?.harbor || null,
              chart
            };
            dayChart = chart;

          } else {
            try{
              const pack = await getTideChartForDate(draft.lat, draft.lng, whenLocal);
              if (pack?.chart){
                draft.tide_daily_cache = draft.tide_daily_cache || {};
                draft.tide_daily_cache[dkey] = { harbor: pack.harbor || null, chart: pack.chart };
                const info = tideInfoFromChart(pack.chart, whenLocal);
                catchForm.tide_level_cm    = info.level_cm;
                catchForm.tide_trend       = info.trend_text;
                catchForm.tide_name        = pack.chart?.moon?.title || null;
                catchForm.tide_harbor_name = pack.harbor?.hn ?? draft.start_tide?.harbor?.hn ?? null;
                dayChart = pack.chart;
              }
            }catch{/* ignore */}
          }
        }

        // 満潮/干潮（最大2つ）を dayChart から確定
        if (dayChart){
          const hl = summarizeHighLowTimesFromChart(dayChart);
          catchForm.tide_high_times = hl.high;  // 例 "04:31／16:52"
          catchForm.tide_low_times  = hl.low;   // 例 "10:12／22:27"
        }
      }

      // 写真アップロード
      if (inpPhoto.files && inpPhoto.files[0]) {
        try {
          const up = await uploadPhotoToDrive(inpPhoto.files[0]);
          catchForm.photoFileId = up.fileId || '';
          catchForm.photoDriveUrl = up.viewUrl || '';
          catchForm.photoDriveThumbUrl = up.thumbUrl || '';
        } catch (e) { console.warn("[PhotoUpload] failed:", e?.message || e); }
      }

      LOG.app("Catch (to be saved & uploaded)", {
        id: catchForm.id,
        timestamp: catchForm.timestamp,
        species: catchForm.species,
        size_cm: catchForm.size_cm,
        tide_cm: catchForm.tide_level_cm,
        trend: catchForm.tide_trend,
        tide_name: catchForm.tide_name,
        harbor: catchForm.tide_harbor_name,
        tide_high_times: catchForm.tide_high_times,
        tide_low_times:  catchForm.tide_low_times,
        photoFileId: catchForm.photoFileId,
      });

      if (editMode && editingId) {
        const i = draft.catches.findIndex(x => x.id === editingId);
        if (i >= 0) { draft.catches[i] = { ...catchForm, id: editingId }; }
      } else {
        draft.catches.push({ ...catchForm });
      }
      saveDraft(draft);
      closeCatchModal();
      render();

      if (!editMode){
        catchForm = { id: uuid(), timestamp: nowIsoLocal(), species:'', size_cm:null, weight_g:null, method:'', photoPreviewUrl: undefined };
      }
    }

    // ===== アップロード確認モーダル =====
    const uploadReviewModal = document.getElementById('uploadReviewModal');
    const uploadReviewBody  = document.getElementById('uploadReviewBody');
    const btnCloseUploadReview = document.getElementById('btnCloseUploadReview');
    const btnCancelUpload = document.getElementById('btnCancelUpload');
    const btnConfirmUpload = document.getElementById('btnConfirmUpload');

    btnCloseUploadReview.onclick = () => { pendingEnd=null; uploadReviewModal.classList.add('hidden'); };
    btnCancelUpload.onclick      = () => { pendingEnd=null; uploadReviewModal.classList.add('hidden'); };

    btnConfirmUpload.onclick = async ()=>{
      try{
        if (pendingEnd){
          draft.status = 'ended';
          draft.endedAt = pendingEnd.endedAt;
          draft.end_weather = pendingEnd.end_weather || null;
          saveDraft(draft);
        }
        const payload = buildTripPayload(draft);

        try {
          const preview = (payload.catches || []).map(c => ({
            id: c.id,
            ts: c.timestamp,
            sp: c.species,
            size: c.size_cm,
            tide_cm: c.tide_level_cm,
            trend: c.tide_trend,
            tide_name: c.tide_name,
            harbor: c.tide_harbor_name,
            tide_high_times: c.tide_high_times,
            tide_low_times:  c.tide_low_times,
            photoId: c.photoFileId
          }));
          LOG.app("Upload payload (Catches preview)", preview);
          if (console?.table) console.table(preview);
        } catch(_){}

        const payloadStr = JSON.stringify(payload);

        const res = await fetch(UPLOAD_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain; charset=UTF-8' },
          body: payloadStr
        });
        const text = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}`);

        let out={}; try{ out = JSON.parse(text); }catch{}
        uploadReviewModal.classList.add('hidden');
        pendingEnd = null;
        draft = { tripId: uuid(), status: 'idle', catches: [], tide_daily_cache: {} };
        saveDraft(draft);
        render();
        showView('home');
        alert('アップロードが完了しました。');
      }catch(e){
        alert('アップロードに失敗しました。ネットワーク/エンドポイントを確認してください。');
      }
    };

    function buildTripPayload(d){
      return {
        tripId: d.tripId,
        status: d.status,
        startedAt: d.startedAt,
        endedAt: d.endedAt,
        position: (typeof d.lat==='number' && typeof d.lng==='number') ? {lat:d.lat, lng:d.lng} : null,
        start_weather: d.start_weather || null,
        end_weather: d.end_weather || null,
        start_tide: d.start_tide || null,
        catches: (d.catches||[]).map(c => ({
          id: c.id,
          timestamp: c.timestamp,
          species: c.species,
          size_cm: c.size_cm,
          weight_g: c.weight_g,
          method: c.method,
          weather: c.weather || null,

          tide_level_cm:   c.tide_level_cm ?? null,
          tide_trend:      c.tide_trend ?? null,
          tide_name:       c.tide_name ?? null,
          tide_harbor_name: c.tide_harbor_name ?? (d.start_tide?.harbor?.hn ?? null),

          // 後方互換キー（従来のフィールド名）
          tide_high_times:  c.tide_high_times ?? c.highTide ?? null,
          tide_low_times:   c.tide_low_times  ?? c.lowTide  ?? null,

          photoFileId: c.photoFileId || null,
          photoDriveUrl: c.photoDriveUrl || null,
          photoDriveThumbUrl: c.photoDriveThumbUrl || null
        }))
      };
    }

    // 終了前レビュー
    function openUploadReview(){
      const cts = draft.catches||[];
      const sum = document.createElement('div');
      sum.className = 'space-y-3';

      const endAtDisplay = pendingEnd?.endedAt ? new Date(pendingEnd.endedAt).toLocaleString() : (draft.endedAt ? new Date(draft.endedAt).toLocaleString() : '—');
      const head = document.createElement('div');
      head.innerHTML =
        `<div class="text-slate-300">Trip ID: <span class="text-slate-100">${draft.tripId.slice(0,8)}</span></div>
        <div class="text-slate-300">開始: <span class="text-slate-100">${draft.startedAt?new Date(draft.startedAt).toLocaleString():'—'}</span></div>
        <div class="text-slate-300">終了: <span class="text-slate-100">${endAtDisplay}</span></div>
        <div class="text-slate-300">件数: <span class="text-slate-100">${cts.length}</span></div>`;
      sum.appendChild(head);

      const wx = document.createElement('div');
      wx.className='grid grid-cols-1 sm:grid-cols-2 gap-2';
      const boxWx = (label, val) => {
        const d=document.createElement('div'); d.className='rounded-xl bg-slate-800/40 p-3';
        d.innerHTML = `<div class="text-xs text-slate-400">${label}</div>
                      <div class="text-sm text-slate-200 mt-0.5">${val||'—'}</div>`;
        return d;
      };
      const sw = draft.start_weather ? formatWeatherBrief(draft.start_weather) : null;
      const ew = pendingEnd?.end_weather || draft.end_weather ? formatWeatherBrief(pendingEnd?.end_weather || draft.end_weather) : null;
      const st = draft.start_tide ? `${draft.start_tide.tideName} / ${draft.start_tide.trendText}` : null;
      wx.appendChild(boxWx('開始時の天気', sw));
      wx.appendChild(boxWx('終了時の天気', ew));
      wx.appendChild(boxWx('開始時の潮', st));
      sum.appendChild(wx);

      if (draft.start_tide?.chart){
        const tideWrap = document.createElement('div');
        tideWrap.className = 'rounded-2xl border border-slate-800 bg-slate-900 p-3';
        const harborName = draft.start_tide?.harbor?.hn || '';
        const dateKey    = draft.start_tide?.chartDateKey || '';
        const title = document.createElement('div');
        title.className = 'text-sm text-slate-300 mb-2';
        title.textContent = `開始日の潮汐グラフ ${harborName ? `（${harborName}）` : ''} ${dateKey ? `- ${dateKey}`:''}`;
        tideWrap.appendChild(title);
        const canvas = document.createElement('canvas');
        canvas.className = 'w-full h-[260px] bg-slate-950 rounded-lg';
        tideWrap.appendChild(canvas);
        sum.appendChild(tideWrap);
        setTimeout(()=> drawTideChartOnCanvas(canvas, draft.start_tide.chart), 0);
      }

      const list = document.createElement('div');
      list.className='divide-y divide-slate-800 rounded-xl border border-slate-800';
      cts.forEach(c=>{
        const row=document.createElement('div'); row.className='p-3 text-sm';
        const t   = c.timestamp? new Date(c.timestamp).toLocaleString(): '';
        const wxs = c.weather? formatWeatherBrief(c.weather): '';
        row.innerHTML =
          `<div class="font-semibold text-slate-100">${c.species||'(魚種未設定)'} <span class="text-slate-400 text-xs ml-2">${t}</span></div>
          <div class="text-slate-300 mt-1">${[c.size_cm!=null?`サイズ:${c.size_cm}cm`:null, c.weight_g!=null?`重量:${c.weight_g}g`:null, c.method||null].filter(Boolean).join(' / ')}</div>
          <div class="text-slate-400 text-xs mt-1">${wxs}</div>`;
      list.appendChild(row);
      });
      sum.appendChild(list);

      uploadReviewBody.innerHTML=''; uploadReviewBody.appendChild(sum);
      uploadReviewModal.classList.remove('hidden');
    }

    async function openTripReview(){
      let endWx = null;
      if (typeof draft.lat === 'number' && typeof draft.lng === 'number'){
        try { endWx = await fetchWeather(draft.lat, draft.lng); } catch(e){}
      }
      pendingEnd = { endedAt: nowIsoLocal(), end_weather: endWx };
      openUploadReview();
    }

    // ===== モーダル操作 =====
    const uploadReviewModalEl = document.getElementById('uploadReviewModal');
    document.getElementById('btnCloseModal').onclick  = ()=> catchModal.classList.add('hidden');
    document.getElementById('btnCancelCatch').onclick = ()=> catchModal.classList.add('hidden');
    document.getElementById('btnSaveCatch').onclick   = submitCatch;
    catchModal.addEventListener('click', (e)=>{ if (e.target === catchModal) catchModal.classList.add('hidden'); });

    // 下部バー
    btnAddCatchBottom.onclick=openAddCatch;
    btnEndBottom.onclick = openTripReview;

    // 初期表示
    render();
  </script>
</body>
</html>
